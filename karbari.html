<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <!-- START: کد ضد کش اضافه شده -->
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
 <meta http-equiv="Pragma" content="no-cache" />
 <meta http-equiv="Expires" content="0" />
 <!-- END: کد ضد کش اضافه شده -->

 <title>صفحه کاربری - رادار اینستاگرام</title>
 <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 <style>
 :root {
 --primary-color: #00D968;
 --primary-light: #E6F8EE;
 --secondary-color: #00B84B;
 --dark-color: #333; /* از #2c3e50 به #333 تغییر یافت برای هماهنگی بیشتر */
 --light-color: #fff; /* سفید */
 --bg-grey: #fcfcfc; /* طوسی خیلی روشن‌تر برای پس‌زمینه اصلی */
 --grey-color: #7f8c8d;
 --white-color: #ffffff;
 --border-color: #ecf0f1;
 --danger-color: #e74c3c;
 --success-color: #2ecc71;
 --warning-color: #f1c40f;
 --shadow: 0 10px 30px rgba(0, 217, 104, 0.1);
 --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
 --border-radius: 16px;
 --transition: all 0.3s ease;
 }

 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: 'Vazirmatn', sans-serif;
 background-color: var(--bg-grey); /* پس‌زمینه به طوسی خیلی روشن تغییر یافت */
 display: flex;
 justify-content: center;
 align-items: flex-start;
 min-height: 100vh;
 direction: rtl;
 padding: 0; /* پدینگ body حذف شد تا هدر به بالا بچسبد */
 color: var(--dark-color);
 line-height: 1.8; /* خطوط متن کمی بازتر برای خوانایی بهتر */
 -webkit-user-select: none;
 -moz-user-select: none;
 -ms-user-select: none;
 user-select: none;
 }

 .container {
 width: 100%;
 max-width: 800px; /* حداکثر عرض به 800px تغییر یافت */
 text-align: center;
 padding: 20px; /* پدینگ برای فاصله محتوا از لبه‌ها */
 }

 .header { /* استایل هدر صفحه کاربری شبیه app-header در کد features */
    text-align: center;
    background-color: var(--light-color); /* نوار سفید */
    padding: 12px 15px; 
    border-bottom: 2px solid var(--primary-light);
    margin-bottom: 20px; /* فاصله از محتوای بعدی */
 }

 .header h1 {
 font-size: 32px;
 font-weight: 800;
 color: var(--dark-color);
 margin-bottom: 10px;
 position: relative;
 display: inline-block;
 padding-bottom: 10px;
 }
 .header h1::after {
 content: '';
 position: absolute;
 bottom: 0;
 right: 50%;
 transform: translateX(50%);
 width: 80px;
 height: 4px;
 background: var(--gradient);
 border-radius: 2px;
 }
 .header h1 i {
 color: var(--primary-color);
 margin-left: 10px;
 }

 /* دکمه .back-button به طور کامل حذف شد */
 /* .profile-card حذف شد */

 .profile-section {
 padding: 20px; /* پدینگ داخلی برای هر سکشن */
 background-color: var(--white-color); /* پس‌زمینه سفید برای هر سکشن */
 border-radius: var(--border-radius);
 box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* سایه ظریف */
 margin-bottom: 20px; /* فاصله بین سکشن‌ها */
 text-align: right;
 }
 .profile-section:last-of-type {
 border-bottom: none;
 padding-bottom: 20px; /* پدینگ پایین برای آخرین سکشن */
 }
 .profile-section:first-of-type {
 padding-top: 20px; /* پدینگ بالا برای اولین سکشن */
 }

 .profile-section h2 { /* استایل عنوان بخش‌ها شبیه section-title در کد features */
    text-align: center;
    font-size: 1.4rem;
    font-weight: 600;
    color: var(--secondary-color);
    margin: 0 0 15px; /* تنظیم مارجین داخلی سکشن */
    display: flex;
    align-items: center;
    justify-content: center; /* مرکز قرار گرفتن عنوان */
 }
 .profile-section h2 i {
 color: var(--primary-color);
 margin-left: 10px;
 font-size: 1.5rem; /* آیکون کمی بزرگتر */
 }

 .info-item { /* استایل آیتم‌های اطلاعاتی شبیه feature-item در کد features */
    display: flex;
    align-items: center;
    justify-content: space-between; /* برای تراز کردن label و value */
    padding: 12px 0; /* پدینگ عمودی برای هر آیتم */
    border-bottom: 1px solid #eee; /* خط جداکننده */
    font-size: 1rem;
 }
 .info-item:last-of-type {
 border-bottom: none;
 }

 .info-label {
 color: var(--grey-color);
 font-weight: 500;
 display: flex;
 align-items: center;
 }
 .info-label i { /* استایل آیکون‌های اطلاعاتی شبیه feature-icon */
 margin-left: 10px; /* فاصله از متن */
 color: var(--primary-color); /* رنگ سبز اصلی */
 font-size: 1.2rem;
 }

 .info-value {
 font-weight: 600;
 color: var(--dark-color);
 display: flex;
 align-items: center;
 gap: 8px; 
 flex-wrap: wrap; 
 }

 .status-badge {
 display: inline-block;
 padding: 6px 12px;
 border-radius: 20px;
 font-size: 13px;
 font-weight: 600;
 color: white;
 }
 .status-badge.active { background-color: var(--success-color); }
 .status-badge.trial { background-color: var(--warning-color); color: var(--dark-color); }
 .status-badge.inactive { background-color: var(--danger-color); }

 .logout-button {
 width: 100%;
 padding: 14px;
 background: var(--danger-color);
 color: white;
 border: none;
 border-radius: 8px;
 font-size: 16px;
 cursor: pointer;
 font-family: 'Vazirmatn', sans-serif;
 font-weight: 700;
 transition: var(--transition);
 margin-top: 20px;
 }
 .logout-button:hover {
 background-color: #c0392b;
 transform: translateY(-2px);
 box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
 }

 .loading-spinner {
 display: flex;
 justify-content: center;
 align-items: center;
 height: 200px;
 }
 .loading-spinner svg {
 animation: spinner_zKoa 2s linear infinite;
 }
 .loading-spinner circle {
 stroke-linecap: round;
 animation: spinner_YpZS 1.5s ease-in-out infinite;
 }
 @keyframes spinner_zKoa { 100% { transform: rotate(360deg); } }
 @keyframes spinner_YpZS {
 0% { stroke-dasharray: 0 150; stroke-dashoffset: 0; }
 47.5% { stroke-dasharray: 42 150; stroke-dashoffset: -16; }
 95%, 100% { stroke-dasharray: 42 150; stroke-dashoffset: -59; }
 }

 .error-message {
 background-color: #f8d7da;
 color: #721c24;
 border: 1px solid #f5c6cb;
 padding: 15px;
 border-radius: var(--border-radius);
 margin-top: 20px;
 font-size: 15px;
 }

 .no-access-container {
 display: flex;
 justify-content: center;
 align-items: center;
 height: 100vh;
 background-color: var(--white-color); /* پس‌زمینه سفید */
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 z-index: 9999;
 }

 .no-access-content {
 background: #fff;
 padding: 40px;
 border-radius: var(--border-radius);
 box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
 width: 100%;
 max-width: 450px;
 text-align: center;
 }

 .no-access-content h2 {
 margin-bottom: 20px;
 color: var(--dark-color);
 }

 .no-access-content p {
 margin-bottom: 30px;
 color: var(--grey-color);
 line-height: 1.6;
 }

 .no-access-content button {
 width: 100%;
 padding: 14px;
 border: none;
 border-radius: 8px;
 font-size: 16px;
 cursor: pointer;
 font-family: 'Vazirmatn', sans-serif;
 margin-bottom: 10px;
 transition: var(--transition);
 }

 .login-button {
 background: var(--gradient);
 color: white;
 }

 .login-button:hover {
 box-shadow: var(--shadow);
 transform: translateY(-2px);
 }

 @media (max-width: 600px) {
 .header h1 { font-size: 28px; }
 .header h1 i { font-size: 20px; }
 .profile-section { padding: 15px; margin-bottom: 15px; } /* کاهش پدینگ و مارجین در موبایل */
 .profile-section h2 { font-size: 1.2rem; margin-bottom: 10px; }
 .profile-section h2 i { font-size: 1.3rem; }
 .info-item { font-size: 15px; flex-direction: column; align-items: flex-end; } /* برای موبایل به حالت ستونی برگردانده شد */
 .info-label { width: 100%; margin-bottom: 5px; }
 .info-value { width: 100%; text-align: left; }
 .status-badge { margin-right: 0; margin-left: 8px; }
 .container { padding: 10px; } /* کاهش پدینگ کلی کانتینر در موبایل */
 }
 </style>
</head>
<body>

<!-- صفحه عدم دسترسی -->
<div id="no-access-container" class="no-access-container" style="display: none;">
 <div class="no-access-content">
 <i class="fas fa-lock" style="font-size: 60px; color: var(--danger-color); margin-bottom: 20px;"></i>
 <h2>دسترسی محدود</h2>
 <p>برای مشاهده صفحه کاربری، لطفاً ابتدا وارد حساب کاربری خود شوید.</p>
 <button class="login-button" onclick="goToLogin()">
 <i class="fas fa-sign-in-alt"></i> ورود به حساب
 </button>
 </div>
</div>

<div class="container">
 <header class="header">
 <h1><i class="fas fa-user-circle"></i> صفحه کاربری</h1>
 </header>

 <div id="loading-state" class="loading-spinner">
 <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
 <g class="spinner_zKoa">
 <circle cx="20" cy="20" r="9.5" fill="none" stroke="var(--primary-color)" stroke-width="3"></circle>
 </g>
 </svg>
 </div>

 <div id="user-profile-content" style="display: none;">
 <div class="profile-section">
 <h2><i class="fas fa-id-card-alt"></i> اطلاعات شخصی</h2>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-user"></i> نام کامل:</span>
 <span class="info-value" id="userName">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-at"></i> ایمیل:</span>
 <span class="info-value" id="userEmail">در حال بارگذاری...</span>
 </div>
 </div>

 <div class="profile-section">
 <h2><i class="fas fa-crown"></i> وضعیت اشتراک</h2>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-check-circle"></i> وضعیت:</span>
 <span class="info-value" id="subscriptionStatusAndPlan">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-hourglass-half"></i> روزهای باقی‌مانده:</span>
 <span class="info-value" id="remainingDays">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-calendar-alt"></i> تاریخ انقضا:</span>
 <span class="info-value" id="expiryDate">در حال بارگذاری...</span>
 </div>
 </div>

 <button id="logout-button" class="logout-button">
 <i class="fas fa-sign-out-alt"></i> خروج از حساب
 </button>
 </div>

 <div id="error-state" class="error-message" style="display: none;">
 <i class="fas fa-exclamation-triangle"></i> خطا در بارگذاری اطلاعات کاربری. لطفاً دوباره تلاش کنید.
 </div>
</div>

<script>
// Global variables
let sessionToken = localStorage.getItem('sessionToken');

// DOM elements
const userNameElem = document.getElementById('userName');
const userEmailElem = document.getElementById('userEmail');
const subscriptionStatusAndPlanElem = document.getElementById('subscriptionStatusAndPlan');
const remainingDaysElem = document.getElementById('remainingDays');
const expiryDateElem = document.getElementById('expiryDate');
const loadingState = document.getElementById('loading-state');
const userProfileContent = document.getElementById('user-profile-content');
const errorState = document.getElementById('error-state');
const logoutButton = document.getElementById('logout-button');
const noAccessContainer = document.getElementById('no-access-container');

// Function to go back to the main app (index.html)
function goBackToApp() {
    window.location.href = 'index.html';
}

async function makeWorkerRequest(endpoint, data = null, method = 'GET') {
    const url = `https://weathered-sun-e806.toolbox-moein.workers.dev${endpoint}`;
    const options = {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        }
    };

    if (sessionToken) {
        options.headers['Authorization'] = `Bearer ${sessionToken}`;
    }

    if (data && method !== 'GET') {
        options.body = JSON.stringify(data);
    }

    try {
        const response = await fetch(url, options);
        const result = await response.json();
        return { success: response.ok, status: response.status, data: result };
    } catch (error) {
        console.error('karbari.html: Request failed:', error);
        return { success: false, error: 'خطای شبکه رخ داد' };
    }
}

async function getSession() {
    console.log("karbari.html: Attempting to get session...");
    if (!sessionToken) {
        console.log("karbari.html: No session token found.");
        return null;
    }

    const result = await makeWorkerRequest('/getsession', null, 'POST');
    if (result.success && result.data && result.data.user) {
        console.log("karbari.html: Session retrieved successfully.");
        return result.data;
    } else {
        console.warn("karbari.html: Invalid session, removing token.");
        localStorage.removeItem('sessionToken');
        return null;
    }
}

async function performLogout() {
    console.log("karbari.html: Performing logout...");
    try {
        await makeWorkerRequest('/signout', null, 'POST');
    } catch (error) {
        console.error("karbari.html: Logout error:", error);
    }
    localStorage.removeItem('sessionToken');
    localStorage.removeItem('deviceId'); 
    window.location.href = 'index.html'; 
}

function goToLogin() {
    window.location.href = 'register.html'; 
}

function getSubscriptionInfo(user) {
    let statusText = "نامشخص",
        planName = "نامشخص",
        remainingDaysText = "نامشخص",
        expiryDateText = "نامشخص",
        statusClass = "";

    const planMap = {
        'monthly': '۱ ماهه',
        'quarterly': '۳ ماهه',
        'semi-annually': '۶ ماهه',
        'yearly': 'یک ساله',
        'trial': 'آزمایشی'
    };

    if (user.subscriptionPlan) {
        planName = planMap[user.subscriptionPlan] || user.subscriptionPlan;
    } else if (user.subscriptionStatus === 'trial') {
        planName = 'آزمایشی';
    }

    const now = new Date();
    let effectiveEndDate = null;

    if (user.subscriptionStatus === 'trial' && user.createdAt) {
        effectiveEndDate = new Date(new Date(user.createdAt).getTime() + 7 * 24 * 60 * 60 * 1000);
        const daysLeft = Math.ceil((effectiveEndDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        
        expiryDateText = effectiveEndDate.toLocaleDateString('fa-IR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        if (daysLeft > 0) {
            statusText = "آزمایشی";
            statusClass = "trial";
            remainingDaysText = `${daysLeft} روز`;
        } else {
            statusText = "پایان یافته";
            statusClass = "inactive";
            remainingDaysText = "پایان یافته";
        }
    } else if (user.subscriptionStatus === 'active' && user.subscriptionExpiryDate) { // Changed from subscriptionEndDate to subscriptionExpiryDate
        effectiveEndDate = new Date(user.subscriptionExpiryDate);
        const daysLeft = Math.ceil((effectiveEndDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));
        
        expiryDateText = effectiveEndDate.toLocaleDateString('fa-IR', { 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric', 
            hour: '2-digit', 
            minute: '2-digit' 
        });

        if (daysLeft > 0) {
            statusText = "فعال";
            statusClass = "active";
            remainingDaysText = `${daysLeft} روز`;
        } else {
            statusText = "پایان یافته";
            statusClass = "inactive";
            remainingDaysText = "پایان یافته";
        }
    } else {
        statusText = "غیرفعال";
        statusClass = "inactive";
        remainingDaysText = "نامشخص";
        expiryDateText = "نامشخص";
    }

    console.log("karbari.html: Final subscription info:", {
        statusText, planName, remainingDaysText, expiryDateText, statusClass
    });

    const combinedStatusAndPlan = `<span class="status-badge ${statusClass}">${statusText}</span> <span>(${planName})</span>`;

    return {
        combinedStatusAndPlan: combinedStatusAndPlan,
        planName: planName,
        remainingDaysText: remainingDaysText,
        expiryDateText: expiryDateText
    };
}

async function loadUserProfile() {
    console.log("karbari.html: Loading user profile...");

    if (loadingState) loadingState.style.display = 'flex';
    if (userProfileContent) userProfileContent.style.display = 'none';
    if (errorState) errorState.style.display = 'none';
    if (noAccessContainer) noAccessContainer.style.display = 'none';

    try {
        const session = await getSession();

        if (!session || !session.user) {
            console.log("karbari.html: No valid session found. Showing no-access.");
            if (loadingState) loadingState.style.display = 'none';
            if (noAccessContainer) noAccessContainer.style.display = 'flex';
            return;
        }

        const user = session.user;
        const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;

        console.log("karbari.html: Displaying user info:", {
            fullName,
            email: user.email,
            subscriptionStatus: user.subscriptionStatus,
            subscriptionPlan: user.subscriptionPlan
        });

        if (userNameElem) userNameElem.textContent = fullName;
        if (userEmailElem) userEmailElem.textContent = user.email;

        const subInfo = getSubscriptionInfo(user);
        if (subscriptionStatusAndPlanElem) subscriptionStatusAndPlanElem.innerHTML = subInfo.combinedStatusAndPlan;
        if (remainingDaysElem) remainingDaysElem.textContent = subInfo.remainingDaysText;
        if (expiryDateElem) expiryDateElem.textContent = subInfo.expiryDateText;

        if (loadingState) loadingState.style.display = 'none';
        if (userProfileContent) userProfileContent.style.display = 'block';

        console.log("karbari.html: User profile loaded successfully");

    } catch (error) {
        console.error("karbari.html: Error loading user profile:", error);
        if (loadingState) loadingState.style.display = 'none';
        if (errorState) errorState.style.display = 'block';
    }
}

// Event listener for logout button
if (logoutButton) { 
    logoutButton.addEventListener('click', async () => {
        console.log("karbari.html: Logout button clicked");
        await performLogout();
    });
}

// Load profile on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log("karbari.html: DOM loaded, loading user profile...");
    loadUserProfile();
});

console.log("✅ karbari.html: All event listeners attached");
</script>

</body>
</html>