<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>صفحه کاربری - رادار اینستاگرام</title>
 <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 <style>
 :root {
 --primary-color: #00D968;
 --primary-light: #E6F8EE;
 --secondary-color: #00B84B;
 --dark-color: #2c3e50;
 --light-color: #f8f9fa;
 --grey-color: #7f8c8d;
 --white-color: #ffffff;
 --border-color: #ecf0f1;
 --danger-color: #e74c3c;
 --success-color: #2ecc71;
 --warning-color: #f1c40f;
 --shadow: 0 10px 30px rgba(0, 217, 104, 0.1);
 --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
 --border-radius: 16px;
 --transition: all 0.3s ease;
 }

 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: 'Vazirmatn', sans-serif;
 background-color: var(--light-color);
 display: flex;
 justify-content: center;
 align-items: flex-start;
 min-height: 100vh;
 direction: rtl;
 padding: 40px 20px;
 color: var(--dark-color);
 line-height: 1.6;
 -webkit-user-select: none;
 -moz-user-select: none;
 -ms-user-select: none;
 user-select: none;
 }

 .container {
 width: 100%;
 max-width: 700px;
 text-align: center;
 }

 .header {
 margin-bottom: 40px;
 }

 .header h1 {
 font-size: 32px;
 font-weight: 800;
 color: var(--dark-color);
 margin-bottom: 10px;
 position: relative;
 display: inline-block;
 padding-bottom: 10px;
 }
 .header h1::after {
 content: '';
 position: absolute;
 bottom: 0;
 right: 50%;
 transform: translateX(50%);
 width: 80px;
 height: 4px;
 background: var(--gradient);
 border-radius: 2px;
 }
 .header h1 i {
 color: var(--primary-color);
 margin-left: 10px;
 }

 .back-button {
 position: fixed;
 top: 20px;
 left: 20px;
 background: var(--primary-color);
 color: white;
 border: none;
 padding: 12px 20px;
 border-radius: 25px;
 font-size: 14px;
 cursor: pointer;
 font-family: 'Vazirmatn', sans-serif;
 font-weight: 600;
 transition: var(--transition);
 box-shadow: 0 4px 15px rgba(0, 217, 104, 0.3);
 z-index: 1000;
 }

 .back-button:hover {
 background-color: var(--secondary-color);
 transform: translateY(-2px);
 box-shadow: 0 6px 20px rgba(0, 217, 104, 0.4);
 }

 .profile-card {
 background: var(--white-color);
 border-radius: var(--border-radius);
 box-shadow: 0 15px 35px rgba(0, 0, 0, 0.08), 0 5px 15px rgba(0, 0, 0, 0.05);
 padding: 30px;
 margin-bottom: 30px;
 border-top: 5px solid var(--primary-color);
 }

 .profile-section {
 padding: 20px 0;
 border-bottom: 1px dashed var(--border-color);
 text-align: right;
 }
 .profile-section:last-of-type {
 border-bottom: none;
 padding-bottom: 0;
 }
 .profile-section:first-of-type {
 padding-top: 0;
 }

 .profile-section h2 {
 font-size: 20px;
 font-weight: 700;
 color: var(--dark-color);
 margin-bottom: 15px;
 display: flex;
 align-items: center;
 }
 .profile-section h2 i {
 color: var(--primary-color);
 margin-left: 10px;
 font-size: 22px;
 }

 .info-item {
 display: flex;
 justify-content: space-between;
 align-items: center;
 padding: 10px 0;
 font-size: 16px;
 border-bottom: 1px solid var(--border-color);
 }
 .info-item:last-of-type {
 border-bottom: none;
 }

 .info-label {
 color: var(--grey-color);
 font-weight: 500;
 display: flex;
 align-items: center;
 }
 .info-label i {
 margin-left: 8px;
 color: var(--secondary-color);
 }

 .info-value {
 font-weight: 600;
 color: var(--dark-color);
 }

 .status-badge {
 display: inline-block;
 padding: 6px 12px;
 border-radius: 20px;
 font-size: 13px;
 font-weight: 600;
 color: white;
 margin-right: 8px;
 }
 .status-badge.active { background-color: var(--success-color); }
 .status-badge.trial { background-color: var(--warning-color); color: var(--dark-color); }
 .status-badge.inactive { background-color: var(--danger-color); }

 .logout-button {
 width: 100%;
 padding: 14px;
 background: var(--danger-color);
 color: white;
 border: none;
 border-radius: 8px;
 font-size: 16px;
 cursor: pointer;
 font-family: 'Vazirmatn', sans-serif;
 font-weight: 700;
 transition: var(--transition);
 margin-top: 20px;
 }
 .logout-button:hover {
 background-color: #c0392b;
 transform: translateY(-2px);
 box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
 }

 .loading-spinner {
 display: flex;
 justify-content: center;
 align-items: center;
 height: 200px;
 }
 .loading-spinner svg {
 animation: spinner_zKoa 2s linear infinite;
 }
 .loading-spinner circle {
 stroke-linecap: round;
 animation: spinner_YpZS 1.5s ease-in-out infinite;
 }
 @keyframes spinner_zKoa { 100% { transform: rotate(360deg); } }
 @keyframes spinner_YpZS {
 0% { stroke-dasharray: 0 150; stroke-dashoffset: 0; }
 47.5% { stroke-dasharray: 42 150; stroke-dashoffset: -16; }
 95%, 100% { stroke-dasharray: 42 150; stroke-dashoffset: -59; }
 }

 .error-message {
 background-color: #f8d7da;
 color: #721c24;
 border: 1px solid #f5c6cb;
 padding: 15px;
 border-radius: var(--border-radius);
 margin-top: 20px;
 font-size: 15px;
 }

 .no-access-container {
 display: flex;
 justify-content: center;
 align-items: center;
 height: 100vh;
 background-color: var(--light-color);
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 z-index: 9999;
 }

 .no-access-content {
 background: #fff;
 padding: 40px;
 border-radius: var(--border-radius);
 box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
 width: 100%;
 max-width: 450px;
 text-align: center;
 }

 .no-access-content h2 {
 margin-bottom: 20px;
 color: var(--dark-color);
 }

 .no-access-content p {
 margin-bottom: 30px;
 color: var(--grey-color);
 line-height: 1.6;
 }

 .no-access-content button {
 width: 100%;
 padding: 14px;
 border: none;
 border-radius: 8px;
 font-size: 16px;
 cursor: pointer;
 font-family: 'Vazirmatn', sans-serif;
 margin-bottom: 10px;
 transition: var(--transition);
 }

 .login-button {
 background: var(--gradient);
 color: white;
 }

 .login-button:hover {
 box-shadow: var(--shadow);
 transform: translateY(-2px);
 }

 @media (max-width: 600px) {
 .header h1 { font-size: 28px; }
 .header h1 i { font-size: 20px; }
 .profile-card { padding: 20px; }
 .profile-section h2 { font-size: 18px; }
 .profile-section h2 i { font-size: 20px; }
 .info-item { font-size: 15px; flex-direction: column; align-items: flex-end; }
 .info-label { width: 100%; margin-bottom: 5px; }
 .info-value { width: 100%; text-align: left; }
 .status-badge { margin-right: 0; margin-left: 8px; }
 .back-button { top: 10px; left: 10px; padding: 10px 16px; font-size: 13px; }
 }
 </style>
</head>
<body>

<!-- دکمه بازگشت -->
<button class="back-button" onclick="goBackToApp()">
 <i class="fas fa-arrow-right"></i> بازگشت به برنامه
</button>

<!-- صفحه عدم دسترسی -->
<div id="no-access-container" class="no-access-container" style="display: none;">
 <div class="no-access-content">
 <i class="fas fa-lock" style="font-size: 60px; color: var(--danger-color); margin-bottom: 20px;"></i>
 <h2>دسترسی محدود</h2>
 <p>برای مشاهده صفحه کاربری، لطفاً ابتدا وارد حساب کاربری خود شوید.</p>
 <button class="login-button" onclick="goToLogin()">
 <i class="fas fa-sign-in-alt"></i> ورود به حساب
 </button>
 </div>
</div>

<div class="container">
 <header class="header">
 <h1><i class="fas fa-user-circle"></i> صفحه کاربری</h1>
 </header>

 <div id="loading-state" class="loading-spinner">
 <svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">
 <g class="spinner_zKoa">
 <circle cx="20" cy="20" r="9.5" fill="none" stroke="var(--primary-color)" stroke-width="3"></circle>
 </g>
 </svg>
 </div>

 <div id="user-profile-content" style="display: none;">
 <div class="profile-card">
 <div class="profile-section">
 <h2><i class="fas fa-id-card-alt"></i> اطلاعات شخصی</h2>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-user"></i> نام کامل:</span>
 <span class="info-value" id="userName">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-at"></i> ایمیل:</span>
 <span class="info-value" id="userEmail">در حال بارگذاری...</span>
 </div>
 </div>

 <div class="profile-section">
 <h2><i class="fas fa-crown"></i> وضعیت اشتراک</h2>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-check-circle"></i> وضعیت:</span>
 <span class="info-value" id="subscriptionStatus">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-box-open"></i> پلن خریداری شده:</span>
 <span class="info-value" id="subscriptionPlan">در حال بارگذاری...</span>
 </div>
 <div class="info-item">
 <span class="info-label"><i class="fas fa-hourglass-half"></i> روزهای باقی‌مانده:</span>
 <span class="info-value" id="remainingDays">در حال بارگذا.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
 } else {
 statusText = "پایان یافته";
 statusClass = "inactive";
 remainingDaysText = "پایان یافته";
 expiryDateText = endDate.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' });
 }
 } else {
 // Default for 'inactive' or missing data
 statusText = "غیرفعال";
 statusClass = "inactive";
 remainingDaysText = "نامشخص";
 expiryDateText = "نامشخص";
 }

 console.log("karbari.html: Final subscription info:", {
 statusText, planName, remainingDaysText, expiryDateText, statusClass
 });

 return {
 statusText: `<span class="status-badge ${statusClass}">${statusText}</span>`,
 planName: planName,
 remainingDaysText: remainingDaysText,
 expiryDateText: expiryDateText
 };
}

async function loadUserProfile() {
 console.log("karbari.html: Loading user profile...");

 if (loadingState) loadingState.style.display = 'flex';
 if (userProfileContent) userProfileContent.style.display = 'none';
 if (errorState) errorState.style.display = 'none';
 if (noAccessContainer) noAccessContainer.style.display = 'none';

 try {
 const session = await getSession();

 if (!session || !session.user) {
 console.log("karbari.html: No valid session found");
 if (loadingState) loadingState.style.display = 'none';
 if (noAccessContainer) noAccessContainer.style.display = 'flex';
 return;
 }

 const user = session.user;
 const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.email;

 console.log("karbari.html: Displaying user info:", {
 fullName,
 email: user.email,
 subscriptionStatus: user.subscriptionStatus,
 subscriptionPlan: user.subscriptionPlan
 });

 if (userNameElem) userNameElem.textContent = fullName;
 if (userEmailElem) userEmailElem.textContent = user.email;

 const subInfo = getSubscriptionInfo(user);
 if (subscriptionStatusElem) subscriptionStatusElem.innerHTML = subInfo.statusText;
 if (subscriptionPlanElem) subscriptionPlanElem.textContent = subInfo.planName;
 if (remainingDaysElem) remainingDaysElem.textContent = subInfo.remainingDaysText;
 if (expiryDateElem) expiryDateElem.textContent = subInfo.expiryDateText;

 if (loadingState) loadingState.style.display = 'none';
 if (userProfileContent) userProfileContent.style.display = 'block';

 console.log("karbari.html: User profile loaded successfully");

 } catch (error) {
 console.error("karbari.html: Error loading user profile:", error);
 if (loadingState) loadingState.style.display = 'none';
 if (errorState) errorState.style.display = 'block';
 }
}

// Event listener for logout button
if (logoutButton) { 
 logoutButton.addEventListener('click', async () => {
 console.log("karbari.html: Logout button clicked");
 await performLogout();
 });
}

// Load profile on page load
document.addEventListener('DOMContentLoaded', function() {
 console.log("karbari.html: DOM loaded, loading user profile...");
 
 if (!sessionToken) {
 console.log("karbari.html: No sessionToken found in localStorage");
 if (loadingState) loadingState.style.display = 'none';
 if (noAccessContainer) noAccessContainer.style.display = 'flex';
 return;
 }
 
 loadUserProfile();
});

console.log("✅ karbari.html: All event listeners attached");
</script>

</body>
</html>