<!DOCTYPE html>
<html lang="fa" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اخبار ویژه دلار، مسکن و اقتصاد | دستیار املاک</title>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3A7DDE;
            --primary-light: #EAF2FF;
            --secondary-color: #2C5A9E;
            --dark-color: #1A3D6D;
            --light-color: #f8f9fa;
            --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            --border-radius: 20px;
            --button-border-radius: 12px;
            --border-color: #dee2e6;
            --font-family: 'Vazirmatn', Arial, sans-serif;
            --card-shadow: 0 10px 30px rgba(58, 125, 222, 0.1);
            --grey-color: #6c757d;
            --text-black-color: #343a40;
            /* رنگ‌بندی برای دسته‌ها */
            --real-estate-color: #FFC107; /* زرد طلایی برای مسکن */
            --economy-color: #008e3a; /* سبز برای اقتصاد */
            --politics-color: #0277bd; /* آبی برای سیاسی */
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: var(--font-family);
            background-color: var(--light-color);
            direction: rtl;
            text-align: right;
            color: var(--text-black-color);
            line-height: 1.7;
        }

        .header {
            background-color: #ffffff;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .logo-placeholder {
            width: 150px;
            height: 60px;
            background-image: url('images/logo.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        main {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 15px;
        }

        .guide-text {
            text-align: center;
            margin: 30px 0 35px 0;
            font-size: 1.2rem;
            color: #444;
            max-width: 680px;
            position: relative;
        }

        .guide-text::after {
            content: '';
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--gradient);
            border-radius: 3px;
        }

        .guide-text .highlight {
            color: var(--primary-color);
            font-weight: 700;
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            max-width: 500px;
            margin-bottom: 40px;
            background: white;
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--card-shadow);
        }

        .search-box { position: relative; width: 100%; }
        .search-box input {
            width: 100%;
            padding: 12px 45px 12px 20px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            font-size: 14px;
            font-family: var(--font-family);
            transition: all 0.3s ease;
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px var(--primary-light);
        }
        .search-box i { position: absolute; right: 18px; top: 50%; transform: translateY(-50%); color: var(--grey-color); }

        .news-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            width: 100%;
            max-width: 1200px;
        }

        .news-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            border: 1px solid #f0f0f0;
        }
        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(58, 125, 222, 0.15);
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .card-category {
            font-size: 11px;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 20px;
            color: white;
        }
        .card-category.real_estate { background-color: var(--real-estate-color); }
        .card-category.economy { background-color: var(--economy-color); }
        .card-category.politics { background-color: var(--politics-color); }

        .card-source {
            font-size: 12px;
            color: var(--grey-color);
        }
        .card-body {
            padding: 20px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .news-title {
            font-size: 17px;
            font-weight: 600;
            color: var(--dark-color);
            margin-bottom: 10px;
            line-height: 1.6;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 54px;
        }
        .news-summary {
            font-size: 14px;
            color: var(--text-black-color);
            margin-bottom: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            flex-grow: 1;
        }
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-top: 1px solid #f0f0f0;
            margin-top: auto;
        }
        .news-date {
            font-size: 12px;
            color: var(--grey-color);
        }
        .read-more-btn {
            background: var(--gradient);
            color: white;
            padding: 8px 18px;
            border: none;
            border-radius: var(--button-border-radius);
            cursor: pointer;
            font-size: 13px;
            font-family: var(--font-family);
            transition: all 0.3s ease;
        }
        .read-more-btn:hover {
             box-shadow: 0 5px 15px rgba(58, 125, 222, 0.3);
             transform: translateY(-2px);
        }

        /* استایل برای نشانگرهای بارگذاری و خطا */
        .loading, .error, .no-news { 
            text-align: center; 
            padding: 40px; 
            background: white; 
            border-radius: var(--border-radius); 
            box-shadow: var(--card-shadow); 
            margin: 20px auto; 
            max-width: 500px;
        }
        .loading i { 
            font-size: 24px; 
            animation: spin 1s linear infinite; 
            color: var(--primary-color); 
            margin-bottom: 10px;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* استایل خاص برای لودر اسکرول بی‌نهایت */
        #infiniteScrollLoader {
            visibility: hidden; /* پنهان کردن اولیه با visibility */
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        #infiniteScrollLoader.is-visible {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="logo-placeholder"></div>
    </header>
    
    <main>
        <p class="guide-text">مهم‌ترین اخبار <span class="highlight">دلار، مسکن و اقتصاد</span> ایران</p>
        <div class="controls"><div class="search-box"><input type="text" id="searchInput" placeholder="جستجو در اخبار..."><i class="fas fa-search"></i></div></div>
        
        <div id="initialLoading" class="loading"><i class="fas fa-spinner"></i><div>در حال بارگذاری اخبار...</div></div>
        <div id="error" class="error" style="display: none;"><h3>خطا در بارگذاری اخبار</h3><p>لطفاً اتصال اینترنت خود را بررسی کرده و دوباره تلاش کنید.</p></div>
        
        <div id="newsContainer" class="news-grid"></div>
        <div id="noNews" class="no-news" style="display: none;"><h3>خبری یافت نشد</h3><p>متأسفانه خبری با این جستجو پیدا نشد.</p></div>
        
        <!-- نشانگر بارگذاری برای اسکرول بی‌نهایت -->
        <div id="infiniteScrollLoader" class="loading"><i class="fas fa-spinner"></i><div>در حال بارگذاری اخبار بیشتر...</div></div>
        
    </main>
    
    <script>
        let allNews = [], displayedNews = [], currentPage = 0, isLoading = false, searchTimeout = null;
        const newsPerPage = 9;
        let observer; // برای Intersection Observer

        const topPriorityKeywords = ['دلار', 'مسکن', 'املاک', 'ملک', 'ملکی', 'ارز', 'طلا', 'سکه'];

        const keywordFilters = {
            real_estate: ['اجاره', 'شهرداری', 'وام مسکن', 'طرح ملی مسکن', 'بافت فرسوده', 'انبوه سازی', 'شهرسازی', 'زمین', 'ویلا', 'آپارتمان', 'خرید خانه', 'قیمت خانه'],
            economy: ['اقتصاد', 'بازار', 'بورس', 'سهام', 'یورو', 'قیمت', 'تورم', 'بانک', 'وام', 'بودجه', 'مالیات', 'تجارت', 'صادرات', 'واردات', 'نفت', 'یارانه', 'حقوق', 'سرمایه‌گذاری', 'شاخص کل', 'سهام عدالت'],
            politics: ['سیاست', 'دولت', 'مجلس', 'رئیس جمهور', 'وزیر', 'نماینده', 'انتخابات', 'برجام', 'تحریم', 'مذاکره']
        };
        const negativeKeywords = [
            'فوتبال', 'ورزش', 'لیگ', 'تیم', 'بازیکن', 'المپیک', 'مدال', // ورزش
            'سینما', 'بازیگر', 'موسیقی', 'حوادث', 'تصادف', 'سوانح', 'سرقت', 'جرم', // هنر و حوادث
            'سلامت', 'تکنولوژی', 'پزشکی', 'گردشگری', 'خودرو', 'فرهنگی', 'هنری', // سلامت، تکنولوژی، فرهنگ
            'اجتماعی', 'بین الملل', 'جهان', 'خارجی', 'آسیب', 'آلودگی', 'محیط زیست', 'طبیعت', 'آب و هوا', 'خشکسالی', 'باران', // اجتماعی، بین‌الملل، محیط زیست
            'غذا', 'آشپزی', 'رستوران', 'خوراک', 'نوشیدنی', 'تغذیه', // غذا
            'مدارس', 'مدرسه', 'دانشگاه', 'دانشجو', 'آموزش', 'پرورش', 'معلم', 'استاد', 'کنکور', 'امتحان', 'حوزه علمیه', 'حوزه', // آموزش
            'بهداشت', 'درمان', 'بیمارستان', 'پزشک', 'دارو', 'بیماری', 'کرونا', 'واکسن', // بهداشت
            'حضرت', 'رسول', 'امام', 'دین', 'مذهب', 'شهادت', 'وفات', 'میلاد', 'جشنواره', 'نمایشگاه', 'کتاب', 'ادبیات', // مذهب و فرهنگ
            'خانواده', 'ازدواج', 'طلاق', 'کودک', 'جوانان', 'سالمندان', 'زنان', 'مردان', // اجتماعی عمومی
            'سوریه', 'غزه', 'اوکراین', 'فلسطین' // اخبار بین‌المللی خاص که معمولا به اقتصاد و مسکن مرتبط نیستند
        ];

        function detectNewsCategory(title, description) {
            const combinedText = (title + ' ' + (description || '')).toLowerCase();
            if (negativeKeywords.some(keyword => combinedText.includes(keyword))) return 'other';
            
            if (keywordFilters.real_estate.some(keyword => combinedText.includes(keyword)) || topPriorityKeywords.some(keyword => combinedText.includes(keyword))) return 'real_estate';
            if (keywordFilters.economy.some(keyword => combinedText.includes(keyword))) return 'economy';
            if (keywordFilters.politics.some(keyword => combinedText.includes(keyword))) return 'politics';
            return 'other';
        }
        
        const sourceNameMap = {
            'خبرگزاری تسنیم': 'خبرگزاری تسنیم', 'خبرگزاری مهر': 'خبرگزاری مهر',
            'خبرگزاری ايسنا': 'خبرگزاری ایسنا', 'خبرگزاری ایسنا': 'خبرگزاری ایسنا',
            'تجارت نیوز': 'تجارت نیوز', 'دنیای اقتصاد': 'دنیای اقتصاد',
            'خبرگزاری فارس': 'خبرگزاری فارس', 'خبرگزاری جمهوری اسلامی': 'خبرگزاری ایرنا',
            'خبرگزاری تابناک': 'تابناک', 'اقتصاد آنلاین': 'اقتصاد آنلاین'
        };
        function cleanSourceName(originalName) {
            for (const key in sourceNameMap) {
                if (originalName.includes(key)) return sourceNameMap[key];
            }
            return originalName.split('|')[0].trim();
        }

        // تابع برای نمایش لودر اسکرول بی‌نهایت
        function showInfiniteScrollLoader() {
            const loader = document.getElementById('infiniteScrollLoader');
            if (loader) {
                loader.classList.add('is-visible');
            }
        }

        // تابع برای پنهان کردن لودر اسکرول بی‌نهایت
        function hideInfiniteScrollLoader() {
            const loader = document.getElementById('infiniteScrollLoader');
            if (loader) {
                loader.classList.remove('is-visible');
            }
        }

        // تابع برای راه‌اندازی Intersection Observer
        function setupIntersectionObserver() {
            const infiniteScrollLoader = document.getElementById('infiniteScrollLoader');
            if (!infiniteScrollLoader) return;

            // ابتدا اگر observer قبلی وجود دارد، آن را قطع می‌کنیم
            if (observer) {
                observer.disconnect();
            }

            const options = {
                root: null, // viewport به عنوان روت (عنصر والد)
                rootMargin: '0px', 
                threshold: 0.1 // وقتی 10 درصد از عنصر قابل مشاهده شد، تریگر کن
            };

            observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    // اگر loader قابل مشاهده است و در حال بارگذاری نیستیم
                    if (entry.isIntersecting && !isLoading) {
                        loadMoreNews();
                    }
                });
            }, options);

            // شروع به مشاهده عنصر loader
            observer.observe(infiniteScrollLoader);
        }

        async function fetchNewsFromRSS() {
            if (isLoading) return;
            isLoading = true;
            document.getElementById('initialLoading').style.display = 'block'; // نمایش لودر اولیه
            hideError();

            const rssFeeds = [
                'https://tejaratnews.com/feed/section/housing', 'https://www.tasnimnews.com/fa/rss/feed/0/8/15',
                'https://www.isna.ir/rss/tp/14', 'https://www.donya-e-eqtesad.com/fa/tiny/feed',
                'https://www.eghtesadonline.com/fa/rss/1', 'https://www.irna.ir/rss/tp/8',
                'https://www.tabnak.ir/fa/rss/1/10', 'https://www.farsnews.ir/rss/group/4',
                'https://www.irna.ir/rss/tp/30', 'https://www.isna.ir/rss/tp/11', 'https://www.mehrnews.com/rss/tp/8',
            ];
            
            const rssToJsonService = 'https://api.rss2json.com/v1/api.json?rss_url=';
            const requests = rssFeeds.map(feed => fetch(rssToJsonService + encodeURIComponent(feed)));
            const responses = await Promise.allSettled(requests);
            
            let newsItems = [];
            for (const result of responses) {
                if (result.status === 'fulfilled') {
                    try {
                        const data = await result.value.json();
                        if (data.status === 'ok' && data.items) {
                            const sourceName = cleanSourceName(data.feed.title);
                            const itemsWithSource = data.items.map(item => ({...item, sourceName }));
                            newsItems.push(...itemsWithSource);
                        }
                    } catch (e) { console.error("خطا در پردازش فید:", e); }
                }
            }
            
            if (newsItems.length === 0) {
                showError();
                document.getElementById('initialLoading').style.display = 'none';
                isLoading = false;
                return;
            }

            let processedNews = newsItems.map(item => {
                const cleanTitle = item.title.replace(/ساخت‌وساز/g, '').replace(/\s\s+/g, ' ').trim();
                let plainDescription = item.description.replace(/<[^>]*>?/gm, '');
                plainDescription = plainDescription.replace(/ساخت‌وساز/g, '').replace(/\s\s+/g, ' ').trim();
                plainDescription = plainDescription.substring(0, 200) + (plainDescription.length > 200 ? '...' : '');
                
                const category = detectNewsCategory(cleanTitle, plainDescription);
                if (category === 'other' || !cleanTitle) return null;
                
                let priority;
                const combinedText = (cleanTitle + ' ' + plainDescription).toLowerCase();

                if (topPriorityKeywords.some(keyword => combinedText.includes(keyword))) {
                    priority = 0; // اولویت ویژه و سطح صفر
                } else {
                    switch (category) {
                        case 'real_estate': priority = 1; break; // اولویت اول
                        case 'economy':     priority = 2; break; // اولویت دوم
                        case 'politics':    priority = 3; break; // اولویت سوم
                        default:            priority = 4;
                    }
                }

                return {
                    title: cleanTitle, description: plainDescription, url: item.link,
                    publishedAt: item.pubDate, category: category, sourceName: item.sourceName,
                    id: item.guid || item.link, priority: priority
                };
            }).filter(Boolean);

            const uniqueUrls = new Set();
            allNews = processedNews.filter(item => {
                if (uniqueUrls.has(item.url)) return false;
                uniqueUrls.add(item.url);
                return true;
            });

            allNews.sort((a, b) => {
                if (a.priority !== b.priority) return a.priority - b.priority;
                return new Date(b.publishedAt) - new Date(a.publishedAt);
            });

            applyFilters(); // این تابع اولین دسته اخبار را نمایش می‌دهد و Observer را هم تنظیم می‌کند
            document.getElementById('initialLoading').style.display = 'none'; // پنهان کردن لودر اولیه
            isLoading = false; // بازنشانی وضعیت بارگذاری اولیه
        }
        
        function applyFilters() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const filteredNews = query ? allNews.filter(n => n.title.toLowerCase().includes(query) || n.description.toLowerCase().includes(query)) : allNews;
            currentPage = 0;
            displayedNews = [];
            document.getElementById('newsContainer').innerHTML = '';
            
            if (filteredNews.length === 0) {
                showNoNews();
                if (observer) observer.disconnect(); // اگر خبری نیست، observer را قطع کن
                hideInfiniteScrollLoader(); // نشانگر لودینگ را پنهان کن
            } else {
                hideNoNews();
                displayNews(filteredNews);
                
                // اگر تعداد کل اخبار فیلتر شده بیشتر از اخبار نمایش داده شده در یک صفحه است، observer را فعال کن
                if (filteredNews.length > newsPerPage) {
                    setupIntersectionObserver();
                    hideInfiniteScrollLoader(); // اطمینان از پنهان بودن نشانگر در ابتدا
                } else {
                    if (observer) observer.disconnect(); // اگر خبری برای لود بیشتر نیست، observer را قطع کن
                    hideInfiniteScrollLoader(); // نشانگر لودینگ را پنهان کن
                }
            }
        }

        function displayNews(newsArray) {
            const container = document.getElementById('newsContainer');
            const newsToDisplay = newsArray.slice(currentPage * newsPerPage, (currentPage + 1) * newsPerPage);
            newsToDisplay.forEach(news => {
                // اطمینان حاصل کنید که خبر تکراری اضافه نشود
                if (!displayedNews.some(item => item.id === news.id)) {
                    container.appendChild(createNewsCard(news));
                    displayedNews.push(news);
                }
            });
        }

        function createNewsCard(news) {
            const card = document.createElement('div');
            card.className = 'news-card';
            const date = new Date(news.publishedAt).toLocaleDateString('fa-IR', { day: 'numeric', month: 'long' });
            
            let categoryText = 'اخبار';
            if (news.category === 'real_estate') categoryText = 'مسکن و املاک';
            else if (news.category === 'economy') categoryText = 'اقتصاد کلان';
            else if (news.category === 'politics') categoryText = 'سیاسی';

            card.innerHTML = `
                <div class="card-header">
                    <span class="card-category ${news.category}">${categoryText}</span>
                    <span class="card-source">${news.sourceName}</span>
                </div>
                <div class="card-body">
                    <h3 class="news-title">${news.title}</h3>
                    <p class="news-summary">${news.description}</p>
                </div>
                <div class="card-footer">
                    <button class="read-more-btn" onclick="window.open('${news.url}', '_blank')">ادامه مطلب</button>
                    <span class="news-date">${date}</span>
                </div>`;
            return card;
        }
        
        function loadMoreNews() {
            const query = document.getElementById('searchInput').value.trim().toLowerCase();
            const currentFilteredNews = query ? allNews.filter(n => n.title.toLowerCase().includes(query) || n.description.toLowerCase().includes(query)) : allNews;

            // اگر در حال بارگذاری هستیم یا همه اخبار نمایش داده شده‌اند، کاری نکن
            if (isLoading || displayedNews.length >= currentFilteredNews.length) {
                hideInfiniteScrollLoader();
                if (observer && displayedNews.length >= currentFilteredNews.length) {
                    observer.disconnect(); // اگر خبری برای لود بیشتر نیست، observer را قطع کن
                }
                return;
            }

            isLoading = true;
            showInfiniteScrollLoader(); // نمایش نشانگر بارگذاری

            currentPage++; // صفحه را برای بارگذاری دسته بعدی افزایش بده
            displayNews(currentFilteredNews); // دسته جدید اخبار را نمایش بده
            
            isLoading = false; // بازنشانی وضعیت بارگذاری پس از نمایش
            hideInfiniteScrollLoader(); // پنهان کردن نشانگر پس از بارگذاری

            // مجدداً بررسی کن که آیا هنوز خبری برای بارگذاری در اسکرول‌های بعدی وجود دارد یا خیر
            if (displayedNews.length >= currentFilteredNews.length && observer) {
                observer.disconnect(); // اگر همه اخبار نمایش داده شده‌اند، observer را قطع کن
            }
        }

        function showLoading() { document.getElementById('initialLoading').style.display = 'block'; }
        function hideLoading() { document.getElementById('initialLoading').style.display = 'none'; }
        function showError() { document.getElementById('error').style.display = 'block'; }
        function hideError() { document.getElementById('error').style.display = 'none'; }
        function showNoNews() { document.getElementById('noNews').style.display = 'block'; }
        function hideNoNews() { document.getElementById('noNews').style.display = 'none'; }

        document.addEventListener('DOMContentLoaded', () => {
            fetchNewsFromRSS();
            document.getElementById('searchInput').addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    if (observer) observer.disconnect(); // قطع observer قبلی در هنگام جستجو
                    applyFilters(); // اعمال فیلترها و راه‌اندازی مجدد observer
                }, 300);
            });
        });
    </script>
</body>
</html>
