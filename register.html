<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">

 <!-- START: کد ضد کش اضافه شده -->
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
 <meta http-equiv="Pragma" content="no-cache" />
 <meta http-equiv="Expires" content="0" />
 <!-- END: کد ضد کش اضافه شده -->

 <title>ورود به جعبه ابزار املاک</title>
 
 <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 
 <style>
    :root {
        /* پالت رنگی جدید: آبی کهکشانی و زرد طلایی (از index.html) */
        --primary-color: #3A7DDE;       /* آبی اصلی، عمیق و فانتزی */
        --primary-light: #EAF2FF;       /* آبی بسیار روشن برای هاور */
        --secondary-color: #2C5A9E;     /* آبی تیره‌تر برای گرادینت */
        --dark-color: #1A3D6D;          /* آبی بسیار تیره برای متون اصلی */
        --light-color: #f8f9fa;         /* پس‌زمینه اصلی بدنه */
        --complementary-color: #FFC107; /* زرد طلایی به عنوان رنگ مکمل و جذاب */
        
        /* متغیرهای عمومی و ساختاری (از index.html) */
        --transition: all 0.3s ease;
        --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        --complementary-gradient: linear-gradient(135deg, var(--complementary-color), #d9a406);
        --border-radius: 20px;
        --button-border-radius: 12px;
        --border-color: #dee2e6;
        --disabled-color: #aaaaaa;
        --font-family: 'Vazirmatn', Arial, sans-serif;
        --font-size-base: 14px;
        
        /* متغیرهای دارک مود (حفظ شده از index.html برای سازگاری آینده) */
        --dark-mode-bg: #121212;
        --dark-mode-text: #ffffff;
        --dark-mode-card: #1e1e1e;
        --dark-mode-border: #333333;
        --arrow-color: #ef00f6; /* این رنگ می‌تواند ثابت بماند یا تغییر کند */
        
        /* متغیرهای باقی‌مانده برای سازگاری (از index.html) */
        --shadow: 0 10px 25px rgba(58, 125, 222, 0.2);
        --card-shadow: 0 15px 35px rgba(58, 125, 222, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
        --subtle-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        --grey-color: #6c757d;
        --danger-color: #e74c3c;
        --text-color: #343a40; /* رنگ متن عمومی */
        --text-light: #6c757d;
        --bg-color: #f8f9fa;    /* این متغیر اکنون برای پس‌زمینه ورودی‌ها استفاده می‌شود */
        --white: #ffffff;       /* پس زمینه صفحه و کارت‌ها */
        
        /* START: رنگ‌های سبز برای پیام موفقیت */
        --success-color: #155724;
        --success-light-bg: #d4edda;
        --success-border-color: #c3e6cb;
        /* END: رنگ‌های سبز برای پیام موفقیت */
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
        font-family: var(--font-family);
        background-color: var(--white); /* زمینه سفید خالص */
        direction: rtl; 
        text-align: right; 
        color: var(--text-color);
        line-height: 1.6; 
        display: flex; 
        justify-content: center; 
        align-items: center; 
        min-height: 100vh; 
        padding: 20px; 
    }
    
    .auth-container { 
        width: 90%;
        max-width: 450px;
        text-align: center; 
    }
    
    .logo-placeholder { 
        width: 200px;
        height: 60px;
        background-image: url('images/logo.png'); 
        background-size: contain; 
        background-repeat: no-repeat; 
        background-position: center; 
        margin: 0 auto 40px;
    }
    
    .intro-text {
        font-size: 16px;
        color: var(--text-color);
        margin-bottom: 30px;
        line-height: 1.8;
        text-align: center;
        padding: 0 10px;
    }
    
    .intro-text .app-name {
        font-weight: 600;
        color: var(--primary-color);
    }
    
    .form-group { 
        margin-bottom: 15px; 
        text-align: right; 
    }
    
    .form-row { 
        display: grid; 
        grid-template-columns: 1fr 1fr; 
        gap: 15px; 
    }
    
    .form-group input { 
        width: 100%; 
        padding: 18px 20px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color); /* خاکستری روشن برای کنتراست */
        border-radius: var(--button-border-radius);
        font-family: var(--font-family);
        font-size: 16px; 
        text-align: right; 
        direction: rtl; 
        transition: var(--transition); 
        color: var(--dark-color);
    }
    
    .form-group input::placeholder {
        color: var(--grey-color);
        text-align: right;
    }
    
    .form-group input:focus { 
        outline: none; 
        box-shadow: 0 0 0 3px rgba(58, 125, 222, 0.15);
        background-color: var(--white);
        border: 1px solid var(--primary-color);
    }
    
    .form-group input.error { 
        border: 1px solid var(--danger-color);
        box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.15);
    }
    
    .password-strength { 
        margin-top: 5px; 
        font-size: 12px; 
        text-align: right; 
        padding-right: 5px; 
    }
    
    .auth-button { 
        width: 100%; 
        padding: 18px;
        margin-top: 30px;
        border: none; 
        border-radius: var(--button-border-radius);
        font-family: var(--font-family);
        font-size: 16px; 
        font-weight: 600; 
        cursor: pointer; 
        transition: var(--transition); 
        background: var(--gradient);
        color: white;
    }
    
    .auth-button:hover:not(:disabled) { 
        transform: translateY(-2px); 
        box-shadow: var(--shadow);
    }
    
    .auth-button:disabled { 
        opacity: 0.6; 
        cursor: not-allowed; 
        transform: none; 
    }
    
    .mode-switch { 
        margin-top: 25px;
        display: flex; 
        justify-content: center; 
        align-items: center;
        font-size: 14px;
    }
    
    .mode-switch p {
        margin-bottom: 0;
        margin-left: 5px;
        color: var(--grey-color);
    }
    
    .mode-switch button { 
        background: none; 
        border: none; 
        color: var(--dark-color);
        cursor: pointer; 
        font-family: var(--font-family);
        font-size: 14px; 
        text-decoration: none;
        font-weight: 500;
        padding: 0;
    }
    
    .mode-switch button:hover { 
        color: var(--primary-color);
        text-decoration: underline;
    }

    .message { 
        margin-top: 20px; 
        padding: 12px; 
        border-radius: 8px; 
        font-size: 14px; 
        text-align: center; 
    }
    
    .message.error { 
        background-color: #ffebee; 
        color: var(--danger-color);
        border: 1px solid #ffcdd2;
    }
    
    /* START: تغییر بر اساس درخواست کاربر - پیام موفقیت سبز و مشخص */
    .message.success { 
        background-color: var(--success-light-bg); 
        color: var(--success-color); 
        border: 1px solid var(--success-border-color);
        font-weight: 600; /* مشخص‌تر کردن فونت */
    }
    /* END: تغییر بر اساس درخواست کاربر */

    .forgot-password-link {
        display: block;
        margin-top: 10px;
        font-size: 13px;
        color: var(--grey-color);
        text-decoration: none;
        text-align: center;
    }
    
    .forgot-password-link:hover {
        color: var(--primary-color);
        text-decoration: underline;
    }

    /* Modal styles for forgot password */
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-backdrop.show {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background-color: var(--white);
        padding: 30px;
        border-radius: var(--border-radius);
        width: 90%;
        max-width: 400px;
        text-align: right;
        transform: translateY(-50px);
        opacity: 0;
        transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        box-shadow: var(--card-shadow);
    }
    
    .modal-backdrop.show .modal-content {
        transform: translateY(0);
        opacity: 1;
    }
    
    .modal-header {
        font-size: 20px;
        font-weight: 700;
        color: var(--dark-color);
        margin-bottom: 20px;
        text-align: center;
    }
    
    .modal-body p {
        font-size: 14px;
        color: var(--grey-color);
        margin-bottom: 20px;
        line-height: 1.7;
    }
    
    .modal-body input {
        width: 100%;
        padding: 15px 18px;
        border: 1px solid var(--border-color);
        background-color: var(--bg-color);
        border-radius: var(--button-border-radius);
        font-family: var(--font-family);
        font-size: 15px;
        text-align: right;
        direction: rtl;
        margin-bottom: 15px;
    }
    
    .modal-body input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(58, 125, 222, 0.15);
    }
    
    .modal-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
    }
    
    .modal-button {
        flex: 1;
        padding: 12px;
        border: none;
        border-radius: var(--button-border-radius);
        font-family: var(--font-family);
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
    }
    
    .modal-button.primary {
        background: var(--gradient);
        color: white;
    }
    
    .modal-button.primary:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow);
    }
    
    .modal-button.secondary {
        background-color: var(--bg-color);
        color: var(--dark-color);
        border: 1px solid var(--border-color);
    }
    
    .modal-button.secondary:hover {
        background-color: var(--primary-light);
    }
    
    .modal-message {
        margin-top: 15px;
        font-size: 13px;
        text-align: center;
    }
    
    .modal-message.success { color: var(--success-color); }
    .modal-message.error { color: var(--danger-color); }
 </style>
</head>
<body>

<div class="auth-container">
 <div class="logo-placeholder"></div>
 
 <p class="intro-text" id="main-intro-text">
 برای ورود و یا ثبت نام در <span class="app-name">جعبه ابزار املاک</span> ایمیل خود را وارد نمایید
 </p>

 <form id="authForm">
 <div id="name-fields" style="display: none;">
 <div class="form-row">
 <div class="form-group">
 <input type="text" id="firstName" placeholder="نام">
 </div>
 <div class="form-group">
 <input type="text" id="lastName" placeholder="نام خانوادگی">
 </div>
 </div>
 </div>

 <div class="form-group">
 <input type="email" id="email" required placeholder="ایمیل" autocomplete="email">
 </div>

 <div class="form-group">
 <input type="password" id="password" required placeholder="رمز عبور" autocomplete="current-password">
 <div id="password-strength" class="password-strength"></div>
 </div>

 <div class="form-group" id="confirm-password-field" style="display: none;">
 <input type="password" id="confirmPassword" placeholder="تأیید رمز عبور">
 </div>
 
 <button type="submit" class="auth-button" id="primary-action">
 <i class="fas fa-sign-in-alt"></i> ورود به جعبه ابزار املاک
 </button>
 </form>
 
 <a href="#" class="forgot-password-link" id="forgot-password-link">
 رمز عبور خود را فراموش کرده‌اید؟
 </a>

 <div class="mode-switch">
 <p id="switch-text">حساب کاربری ندارید؟</p>
 <button type="button" id="mode-switch-btn">ثبت‌نام کنید</button>
 </div>

 <div id="message" class="message" style="display: none;"></div>
</div>

<!-- Forgot Password Modal -->
<div id="forgot-password-modal" class="modal-backdrop">
 <div class="modal-content">
 <div class="modal-header">بازیابی رمز عبور</div>
 <div class="modal-body">
 <p>لطفاً ایمیل خود را وارد کنید تا لینک بازیابی رمز عبور برای شما ارسال شود.</p>
 <input type="email" id="forgot-password-email" placeholder="ایمیل شما" required>
 <div id="forgot-password-message" class="modal-message" style="display: none;"></div>
 </div>
 <div class="modal-buttons">
 <button class="modal-button primary" id="send-reset-link-btn">ارسال لینک بازیابی</button>
 <button class="modal-button secondary" id="cancel-reset-btn">لغو</button>
 </div>
 </div>
</div>

<script>
    console.log("✅ register.html: Script loaded");
    
    let currentMode = 'login';
    let currentDeviceId = null;
    
    // آدرس Worker کلودفلر شما
    const WORKER_URL = 'https://weathered-sun-e806.toolbox-moein.workers.dev';
    
    // تابع کمکی برای ترجمه خطاهای Worker به فارسی
    function translateWorkerError(message) {
        if (message.includes("لطفاً تمام فیلدها را پر کنید.")) {
            return "لطفاً تمام فیلدهای نام، نام خانوادگی، ایمیل و رمز عبور را پر کنید.";
        }
        if (message.includes("رمز عبور باید حداقل ۶ کاراکتر باشد.")) {
            return "رمز عبور باید حداقل ۶ کاراکتر باشد.";
        }
        if (message.includes("این ایمیل قبلاً ثبت‌نام شده است.")) {
            return "این ایمیل قبلاً ثبت‌نام شده است. لطفاً وارد شوید.";
        }
        if (message.includes("ایمیل یا رمز عبور وارد شده اشتباه است.")) {
            return "ایمیل یا رمز عبور وارد شده اشتباه است.";
        }
        if (message.includes("کاربر یافت نشد.")) {
            return "کاربری با این ایمیل یافت نشد.";
        }
        if (message.includes("نشست نامعتبر است.")) {
            return "نشست شما نامعتبر یا منقضی شده است. لطفاً دوباره وارد شوید.";
        }
        if (message.includes("مشکلی در اتصال به سرور پیش آمد.")) {
            return "مشکلی در اتصال به سرور پیش آمد. لطفاً دوباره تلاش کنید.";
        }
        if (message.includes("خطا در ایجاد درخواست پرداخت")) {
            return "مشکلی در ایجاد درخواست پرداخت در سمت سرور رخ داد. لطفاً با پشتیبانی تماس بگیرید.";
        }
        if (message.includes("لطفاً ایمیل خود را وارد کنید.")) {
            return "لطفاً ایمیل خود را وارد کنید.";
        }
        if (message.includes("توکن بازیابی نامعتبر یا منقضی شده است.")) {
            return "لینک بازیابی رمز عبور نامعتبر یا منقضی شده است. لطفاً دوباره درخواست دهید.";
        }
        if (message.includes("رمز عبور جدید باید حداقل 6 کاراکتر باشد.")) {
            return "رمز عبور جدید باید حداقل 6 کاراکتر باشد.";
        }
        if (message.includes("اطلاعات بازیابی رمز عبور ناقص است.")) {
            return "اطلاعات بازیابی رمز عبور ناقص است. لطفاً مطمئن شوید از لینک صحیح استفاده می‌کنید.";
        }
        if (message.includes("خطایی در ارسال ایمیل بازیابی رخ داد. لطفاً دوباره تلاش کنید.")) {
            return "خطایی در ارسال ایمیل بازیابی رخ داد. لطفاً با پشتیبانی تماس بگیرید.";
        }
        if (message.includes("login_conflict")) {
            return "شما قبلاً در دستگاه دیگری وارد شده‌اید. لطفاً در دستگاه جدید تایید کنید.";
        }
    
        return message;
    }
    
    // تولید Device ID
    function generateDeviceId() {
        let deviceId = localStorage.getItem('deviceId');
        if (!deviceId) {
            deviceId = 'device-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now();
            localStorage.setItem('deviceId', deviceId);
            console.log("Generated new deviceId:", deviceId);
        } else {
            console.log("Using existing deviceId:", deviceId);
        }
        return deviceId;
    }
    
    // نمایش پیام
    function showMessage(text, type = 'error') {
        const messageDiv = document.getElementById('message');
        messageDiv.textContent = text;
        messageDiv.className = `message ${type}`;
        messageDiv.style.display = 'block';
    }
    
    // درخواست به Worker
    async function makeWorkerRequest(endpoint, data = null, method = 'GET') {
        const url = `${WORKER_URL}${endpoint}`;
        
        const options = {
            method: method,
            headers: {
                'Content-Type': 'application/json',
            },
        };
        
        if (data && method !== 'GET') {
            options.body = JSON.stringify(data);
        }
        
        console.log('Making request to:', url);
        
        try {
            const response = await fetch(url, options);
            const result = await response.json();
            
            console.log('Response status:', response.status);
            console.log('Response data:', result);
            
            return { 
                success: response.ok, 
                status: response.status,
                data: result 
            };
        } catch (error) {
            console.error('Request failed:', error); 
            return { 
                success: false, 
                error: 'خطای شبکه رخ داد' 
            };
        }
    }
    
    // بررسی نشست فعال
    async function checkExistingSession() {
        const sessionToken = localStorage.getItem('sessionToken');
        if (!sessionToken) {
            console.log("No sessionToken found");
            return false;
        }
        
        console.log("Found sessionToken, checking validity...");
        
        try {
            const response = await fetch(`${WORKER_URL}/getsession`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${sessionToken}`,
                    'X-Device-Id': currentDeviceId // ارسال deviceId برای بررسی تداخل
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.user) {
                    console.log("✅ Valid session found, redirecting to index.html");
                    window.location.href = 'index.html';
                    return true;
                }
            } else {
                console.log("❌ Invalid session, removing token");
                localStorage.removeItem('sessionToken');
            }
        } catch (error) {
            console.error("Session check error:", error);
            localStorage.removeItem('sessionToken');
        }
        
        return false;
    }
    
    // ورود
    async function performSignIn(email, password) {
        console.log("🔄 Attempting signin for:", email);
        
        try {
            const result = await makeWorkerRequest('/signin', { email, password, deviceId: currentDeviceId }, 'POST');
            
            if (result.success && result.data && result.data.sessionToken && result.data.user) {
                console.log("✅ Signin successful");
                localStorage.setItem('sessionToken', result.data.sessionToken);
                showMessage('ورود موفقیت‌آمیز! در حال انتقال...', 'success');
                
                setTimeout(() => {
                    console.log("🔄 Redirecting to index.html");
                    window.location.href = 'index.html';
                }, 1500);
                
                return true;
            } else {
                console.log("❌ Signin failed");
                if (result.data && result.data.error === "login_conflict") {
                    const conflictingEmail = email;
                    window.location.href = `index.html?loginConflict=true&email=${encodeURIComponent(conflictingEmail)}`;
                    return false;
                }
                showMessage(translateWorkerError(result.data.error || 'خطای ورود'), 'error');
                return false;
            }
        } catch (error) {
            console.error("❌ Signin error:", error);
            showMessage('خطای شبکه در ورود', 'error');
            return false;
        }
    }
    
    // ثبت نام
    async function performSignUp(email, password, firstName, lastName) {
        console.log("🔄 Attempting signup for:", email);
        
        try {
            const result = await makeWorkerRequest('/signup', { firstName, lastName, email, password }, 'POST');
            
            if (result.success && result.data && result.data.sessionToken && result.data.user) {
                console.log("✅ Signup successful");
                localStorage.setItem('sessionToken', result.data.sessionToken);
                showMessage('ثبت‌نام موفقیت‌آمیز! در حال انتقال...', 'success');
                
                setTimeout(() => {
                    console.log("🔄 Redirecting to index.html");
                    window.location.href = 'index.html';
                }, 1500);
                
                return true;
            } else {
                console.log("❌ Signup failed");
                showMessage(translateWorkerError(result.data.error || 'خطای ثبت‌نام'), 'error');
                return false;
            }
        } catch (error) {
            console.error("❌ Signup error:", error);
            showMessage('خطای شبکه در ثبت‌نام', 'error');
            return false;
        }
    }
    
    // بازیابی رمز عبور
    async function requestPasswordResetInternal(email) {
        console.log("🔄 Requesting password reset for:", email);
        
        try {
            const result = await makeWorkerRequest('/forgot-password', { email }, 'POST');
            
            return {
                success: result.success,
                message: translateWorkerError(result.data.message || result.data.error || 'خطای نامشخص')
            };
        } catch (error) {
            console.error("❌ Password reset error:", error);
            return {
                success: false,
                message: 'خطای شبکه'
            };
        }
    }
    
    // تعویض حالت
    function switchMode() {
        const nameFields = document.getElementById('name-fields');
        const confirmPasswordField = document.getElementById('confirm-password-field');
        const primaryActionBtn = document.getElementById('primary-action');
        const mainIntroText = document.getElementById('main-intro-text');
        const switchText = document.getElementById('switch-text');
        const modeSwitchBtn = document.getElementById('mode-switch-btn');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const authForm = document.getElementById('authForm');
        const messageDiv = document.getElementById('message');
        const passwordStrength = document.getElementById('password-strength');
        
        currentMode = (currentMode === 'login') ? 'signup' : 'login';
        
        if (currentMode === 'signup') {
            mainIntroText.innerHTML = 'برای ایجاد حساب کاربری جدید در <span class="app-name">جعبه ابزار املاک</span> اطلاعات خود را وارد نمایید';
            primaryActionBtn.innerHTML = '<i class="fas fa-user-plus"></i> ثبت‌نام در جعبه ابزار املاک';
            switchText.textContent = 'قبلاً ثبت‌نام کرده‌اید؟';
            modeSwitchBtn.textContent = 'وارد شوید';
            nameFields.style.display = 'block';
            confirmPasswordField.style.display = 'block';
            forgotPasswordLink.style.display = 'none';
        } else {
            mainIntroText.innerHTML = 'برای ورود و یا ثبت نام در <span class="app-name">جعبه ابزار املاک</span> ایمیل خود را وارد نمایید';
            primaryActionBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ورود به جعبه ابزار املاک';
            switchText.textContent = 'حساب کاربری ندارید؟';
            modeSwitchBtn.textContent = 'ثبت‌نام کنید';
            nameFields.style.display = 'none';
            confirmPasswordField.style.display = 'none';
            forgotPasswordLink.style.display = 'block';
        }
        
        authForm.reset();
        messageDiv.style.display = 'none';
        passwordStrength.textContent = '';
        document.querySelectorAll('input.error').forEach(input => input.classList.remove('error'));
    }
    
    // اعتبارسنجی فرم
    function validateForm() {
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const firstNameInput = document.getElementById('firstName');
        const lastNameInput = document.getElementById('lastName');
        const confirmPasswordInput = document.getElementById('confirmPassword');
        
        let isValid = true;
        document.querySelectorAll('input.error').forEach(input => input.classList.remove('error'));
        
        if (!emailInput.value.trim()) { 
            emailInput.classList.add('error'); 
            isValid = false; 
        }
        if (!passwordInput.value) { 
            passwordInput.classList.add('error'); 
            isValid = false; 
        }
        
        if (currentMode === 'signup') {
            if (!firstNameInput.value.trim()) { 
                firstNameInput.classList.add('error'); 
                isValid = false; 
            }
            if (!lastNameInput.value.trim()) { 
                lastNameInput.classList.add('error'); 
                isValid = false; 
            }
            if (passwordInput.value.length < 6) {
                passwordInput.classList.add('error');
                showMessage('رمز عبور باید حداقل 6 کاراکتر باشد.', 'error');
                isValid = false;
            }
            if (passwordInput.value !== confirmPasswordInput.value) {
                confirmPasswordInput.classList.add('error');
                showMessage('رمزهای عبور مطابقت ندارند.', 'error');
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    // بررسی قدرت رمز عبور (رنگ‌ها هماهنگ شده با پالت جدید)
    function checkPasswordStrength(password) {
        const passwordStrength = document.getElementById('password-strength');
        
        if (currentMode !== 'signup' || !password) {
            passwordStrength.textContent = '';
            return;
        }
        
        let strength = 0;
        let feedback = '';
        let color = ''; 
        
        if (password.length >= 8) strength++;
        if (/[a-z]/.test(password)) strength++;
        if (/[A-Z]/.test(password)) strength++;
        if (/[0-9]/.test(password)) strength++;
        if (/[^A-Za-z0-9]/.test(password)) strength++;
        
        if (password.length < 6) {
            feedback = 'رمز عبور خیلی کوتاه است';
            color = '#e74c3c'; // --danger-color
        } else if (strength < 3) {
            feedback = 'رمز عبور ضعیف است';
            color = '#FFC107'; // --complementary-color (زرد برای هشدار)
        } else if (strength < 4) {
            feedback = 'رمز عبور متوسط است';
            color = '#3A7DDE'; // --primary-color (آبی اصلی)
        } else {
            feedback = 'رمز عبور قوی است';
            color = '#3A7DDE'; // --primary-color (آبی اصلی)
        }
        
        passwordStrength.textContent = feedback;
        passwordStrength.style.color = color; 
    }
    
    // Modal functions
    function showModal(modal) {
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('show'), 10);
    }
    
    function hideModal(modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
            document.getElementById('forgot-password-email').value = '';
            document.getElementById('forgot-password-message').style.display = 'none';
        }, 300);
    }
    
    function showModalMessage(element, text, type) {
        element.textContent = text;
        element.className = `modal-message ${type}`;
        element.style.display = 'block';
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
        console.log("✅ DOM loaded");
        
        // تولید Device ID
        currentDeviceId = generateDeviceId();
        
        // بررسی نشست موجود
        checkExistingSession();
        
        // تعویض حالت
        document.getElementById('mode-switch-btn').addEventListener('click', switchMode);
        
        // بررسی قدرت رمز عبور
        document.getElementById('password').addEventListener('input', function(e) {
            checkPasswordStrength(e.target.value);
        });
        
        // ارسال فرم
        document.getElementById('authForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log("=== FORM SUBMIT ===");
            
            if (!validateForm()) {
                console.log("❌ Form validation failed");
                return;
            }
            
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const firstNameInput = document.getElementById('firstName');
            const lastNameInput = document.getElementById('lastName');
            const primaryActionBtn = document.getElementById('primary-action');
            
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            
            primaryActionBtn.disabled = true;
            primaryActionBtn.textContent = 'در حال پردازش...';
            
            try {
                let success = false;
                
                if (currentMode === 'login') {
                    success = await performSignIn(email, password);
                } else {
                    success = await performSignUp(email, password, firstNameInput.value.trim(), lastNameInput.value.trim());
                }
                
                console.log("Auth result:", success ? "SUCCESS" : "FAILED");
                
            } catch (error) {
                console.error("❌ Form submit error:", error);
                showMessage('خطای غیرمنتظره رخ داد', 'error');
            } finally {
                primaryActionBtn.disabled = false;
                primaryActionBtn.innerHTML = currentMode === 'login' 
                    ? '<i class="fas fa-sign-in-alt"></i> ورود به جعبه ابزار املاک'
                    : '<i class="fas fa-user-plus"></i> ثبت‌نام در جعبه ابزار املاک';
            }
        });
        
        // فراموشی رمز عبور
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const forgotPasswordModal = document.getElementById('forgot-password-modal');
        const forgotPasswordEmailInput = document.getElementById('forgot-password-email');
        const sendResetLinkBtn = document.getElementById('send-reset-link-btn');
        const cancelResetBtn = document.getElementById('cancel-reset-btn');
        const forgotPasswordMessageDiv = document.getElementById('forgot-password-message');
        
        forgotPasswordLink.addEventListener('click', function(e) {
            e.preventDefault();
            showModal(forgotPasswordModal);
            forgotPasswordEmailInput.value = document.getElementById('email').value;
        });
        
        cancelResetBtn.addEventListener('click', function() {
            hideModal(forgotPasswordModal);
        });
        
        forgotPasswordModal.addEventListener('click', function(e) {
            if (e.target === forgotPasswordModal) {
                hideModal(forgotPasswordModal);
            }
        });
        
        sendResetLinkBtn.addEventListener('click', async function() {
            const email = forgotPasswordEmailInput.value.trim();
            if (!email) {
                showModalMessage(forgotPasswordMessageDiv, "لطفاً ایمیل خود را وارد کنید.", 'error');
                return;
            }
            
            sendResetLinkBtn.disabled = true;
            forgotPasswordEmailInput.disabled = true;
            showModalMessage(forgotPasswordMessageDiv, "در حال ارسال لینک بازیابی...", 'info');
            
            try {
                const result = await requestPasswordResetInternal(email); // استفاده از تابع داخلی
                
                if (result.success) {
                    showModalMessage(forgotPasswordMessageDiv, result.message, 'success');
                    setTimeout(() => hideModal(forgotPasswordModal), 2000);
                } else {
                    showModalMessage(forgotPasswordMessageDiv, result.message, 'error');
                }
            } catch (error) {
                showModalMessage(forgotPasswordMessageDiv, "خطای شبکه رخ داد", 'error');
            } finally {
                sendResetLinkBtn.disabled = false;
                forgotPasswordEmailInput.disabled = false;
            }
        });
    });
    
    console.log("✅ register.html: All event listeners attached");
</script>

</body>
</html>
