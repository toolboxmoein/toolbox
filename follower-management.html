<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>مدیریت فالوورها</title>

 <!-- فونت وزیر -->
 <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
 <!-- Font Awesome برای آیکون‌ها -->
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

 <style>
 /* --- متغیرهای اصلی --- */
 :root {
 --primary-color: #00D968; --primary-light: #E6F8EE; --secondary-color: #00B84B; --dark-color: #333; --light-color: #f8f9fa;
 --shadow: 0 10px 30px rgba(0, 217, 104, 0.1); --transition: all 0.3s ease;
 --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
 --card-shadow: 0 15px 35px rgba(0, 217, 104, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
 --subtle-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
 --border-radius: 16px; --button-border-radius: 8px; --border-color: #e0e0e0;
 --grey-color: #6c757d; --grey-light: #f8f9fa;
 --grey-medium: #dee2e6;
 --success-color: #28a745;
 --danger-color: #e53935;
 --warning-color: #ffc107; --info-color: #17a2b8;
 }
 * {
 margin: 0;
 padding: 0;
 box-sizing: border-box;
 }

 body {
 font-family: 'Vazirmatn', Arial, sans-serif;
 background-color: var(--light-color);
 direction: rtl;
 text-align: right;
 color: var(--dark-color);
 line-height: 1.6;
 padding: 20px;
 }

 body.modal-open {
 overflow: hidden;
 }

 /* استایل‌های اصلی */
 .stats-container {
 display: flex;
 flex-wrap: wrap;
 justify-content: center;
 gap: 15px;
 margin-bottom: 15px;
 width: 100%;
 }
 .stat-card {
 padding: 10px 15px;
 border-radius: var(--border-radius);
 text-align: center;
 background-color: white;
 box-shadow: var(--card-shadow);
 transition: var(--transition);
 flex: 1;
 min-width: 140px;
 cursor: pointer;
 border: 2px solid transparent;
 }
 .stat-card:hover {
 transform: translateY(-4px);
 }
 .stat-card.active {
 box-shadow: 0 2px 8px rgba(0, 217, 104, 0.3), inset 0 0 0 2px var(--primary-color);
 background-color: var(--primary-light);
 }
 .stat-card[data-status-filter="all"] .stat-value { color: var(--dark-color); }
 .stat-card[data-status-filter="new_follower"] .stat-value { color: var(--info-color); }
 .stat-card[data-status-filter="pending"] .stat-value { color: var(--primary-color); }
 .stat-card[data-status-filter="check_needed"] .stat-value { color: var(--warning-color); }
 .stat-card[data-status-filter="responded"] .stat-value { color: var(--success-color); }
 .stat-card[data-status-filter="today_check"] .stat-value { color: #fd7e14; }
 .stat-card[data-status-filter="no-response"] .stat-value { color: var(--danger-color); }
 .stat-value {
 font-size: 1.5rem;
 font-weight: 700;
 margin-bottom: 5px;
 }
 .stat-label {
 font-size: 0.9rem;
 color: var(--grey-color);
 font-weight: 500;
 }
 .controls-header {
 background-color: white;
 border-radius: var(--border-radius);
 box-shadow: var(--card-shadow);
 padding: 12px 20px;
 display: flex;
 flex-direction: column;
 justify-content: center;
 align-items: center;
 gap: 10px;
 margin-bottom: 25px;
 width: 100%;
 }
 .sort-controls {
 width: 100%;
 margin-right: 0;
 }
 .sort-controls select {
 width: 100%;
 padding: 10px 15px;
 border: 2px solid var(--grey-medium);
 border-radius: var(--button-border-radius);
 font-size: 0.9rem;
 color: var(--dark-color);
 background-color: white;
 cursor: pointer;
 outline: none;
 transition: border-color 0.3s;
 }
 .sort-controls select:focus {
 border-color: var(--primary-color);
 }
 .main-controls {
 display: flex; 
 flex-direction: column;
 align-items: center;
 gap: 5px; /* فاصله کم بین دکمه‌ها */
 margin-top: 20px;
 margin-bottom: 20px;
 width: 100%;
 max-width: 400px; /* محدود کردن عرض کل کانتینر */
 margin-left: auto;
 margin-right: auto;
 }
 .action-button {
 background-color: #f2f2f2;
 border: 1px solid #d9d9d9;
 border-radius: var(--button-border-radius);
 padding: 10px 15px;
 font-size: 0.9rem;
 color: var(--dark-color);
 cursor: pointer;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 transition: all 0.3s ease;
 text-decoration: none;
 white-space: nowrap;
 font-family: 'Vazirmatn', Arial, sans-serif;
 }
 #add-followers-btn {
 width: 100%; /* عرض کامل در کانتینر */
 }
 .action-button i {
 margin-left: 8px;
 font-size: 1.1em;
 }
 .action-button.primary {
 background-color: var(--primary-color);
 color: white;
 border-color: var(--primary-color);
 }
 .action-button.danger {
 background-color: var(--danger-color);
 color: white;
 border-color: var(--danger-color);
 }
 .controls-button-row {
 display: flex;
 justify-content: space-between; /* توزیع یکنواخت دکمه‌ها */
 gap: 10px;
 width: 100%; /* عرض کامل برابر با دکمه بالایی */
 }
 .controls-button-row .action-button {
 flex: 1; /* هر دکمه یک سوم عرض کل */
 }
 .list-action-button {
 padding: 8px 12px;
 font-size: 0.9rem;
 min-width: auto;
 flex-grow: 1;
 flex-shrink: 1;
 background-color: var(--primary-light);
 color: var(--primary-color);
 border: 1px solid var(--border-color);
 font-family: 'Vazirmatn', Arial, sans-serif;
 border-radius: 12px;
 }
 .list-action-button:hover:not(:disabled) {
 background-color: var(--primary-color);
 color: white;
 border-color: var(--primary-color);
 }
 .follower-list {
 margin-top: 0;
 text-align: right;
 }
 .follower-item {
 display: flex;
 flex-direction: column;
 align-items: flex-start;
 gap: 8px;
 padding: 12px 15px 8px 15px;
 border: 1px solid var(--grey-medium);
 border-radius: 10px;
 margin-bottom: 10px;
 background-color: white;
 cursor: pointer;
 direction: ltr;
 box-shadow: var(--subtle-shadow);
 }
 .follower-item:hover {
 box-shadow: var(--card-shadow);
 transform: translateY(-2px);
 }
 .follower-info-row {
 display: flex;
 align-items: center;
 gap: 15px;
 width: 100%;
 direction: ltr;
 }
 .follower-avatar {
 flex-shrink: 0;
 width: 40px;
 height: 40px;
 border-radius: 50%;
 background-color: var(--primary-light);
 display: flex;
 align-items: center;
 justify-content: center;
 color: var(--primary-color);
 font-size: 18px;
 font-weight: 600;
 }
 .follower-details {
 flex-grow: 1;
 text-align: left;
 overflow: hidden;
 display: flex;
 flex-direction: column;
 align-items: flex-start;
 gap: 2px;
 direction: ltr;
 }
 .follower-username-row {
 display: flex;
 align-items: center;
 gap: 8px;
 width: 100%;
 direction: ltr;
 justify-content: flex-start;
 flex-wrap: wrap;
 }
 .follower-username {
 font-weight: 600;
 color: var(--dark-color);
 white-space: nowrap;
 overflow: hidden;
 text-overflow: ellipsis;
 }
 .follower-name {
 font-size: 0.9rem;
 color: var(--grey-color);
 white-space: nowrap;
 overflow: hidden;
 text-overflow: ellipsis;
 width: 100%;
 text-align: left;
 }
 .follower-status-new-label {
 font-size: 0.8rem;
 font-weight: 500;
 color: var(--primary-color);
 background-color: var(--primary-light);
 padding: 2px 6px;
 border-radius: 4px;
 display: inline-flex;
 align-items: center;
 gap: 4px;
 flex-shrink: 0;
 }
 .follower-status {
 font-size: 0.85rem;
 color: var(--grey-color);
 display: inline-block;
 margin-right: 8px;
 flex-shrink: 0;
 }
 .follower-status.status-new_follower {
 color: var(--info-color);
 }
 .follower-status.status-pending {
 color: var(--primary-color);
 }
 .follower-status.status-check_needed {
 color: var(--warning-color);
 font-weight: 500;
 }
 .follower-status.status-responded {
 color: var(--success-color);
 }
 .follower-status.status-no-response {
 color: var(--danger-color);
 }
 .follower-actions {
 width: 100%;
 display: flex;
 flex-wrap: nowrap;
 gap: 5px;
 align-items: center;
 justify-content: flex-end;
 margin-top: 5px;
 padding-top: 5px;
 border-top: 1px solid var(--grey-light);
 direction: rtl;
 }
 .form-group {
 margin-bottom: 20px;
 text-align: right;
 width: 100%;
 }
 label {
 font-weight: 500;
 margin-bottom: 8px;
 display: block;
 }
 select, input[type="text"], input[type="number"], textarea {
 width: 100%;
 padding: 12px;
 border: 1px solid #ddd;
 border-radius: var(--button-border-radius);
 outline: none;
 font-size: 1.0rem;
 margin-bottom: 5px;
 font-family: 'Vazirmatn', Arial, sans-serif;
 box-sizing: border-box;
 }
 input[type="number"]::-webkit-inner-spin-button,
 input[type="number"]::-webkit-outer-spin-button {
 -webkit-appearance: none;
 margin: 0;
 }
 input[type="number"] {
 -moz-appearance: textfield;
 appearance: textfield;
 }
 #search-followers {
 width: 100%;
 margin-bottom: 20px;
 }
 #new-follower-username {
 direction: ltr;
 text-align: left;
 }
 #new-follower-name {
 direction: rtl;
 text-align: right;
 }
 
 /* استایل ایموجی‌های اینستاگرام */
 .instagram-emoji-label {
 display: flex;
 align-items: center;
 gap: 0.5mm;
 }
 .instagram-like-emoji {
 font-size: 1.2em;
 color: #ed4956;
 }
 .instagram-comment-emoji {
 font-size: 1.2em;
 color: #262626;
 }

 /* اضافه کردن استایل ایموجی برای صفحه نمایش پروفایل */
 .detail-label.instagram-emoji-label {
 display: flex;
 align-items: center;
 gap: 0.5mm;
 }
 
 textarea {
 min-height: 100px;
 resize: vertical;
 }
 .form-button-row {
 display: flex;
 gap: 20px;
 width: 100%;
 }
 .form-button-row .action-button, 
 .form-button-row .dm-button {
 flex: 1;
 padding: 12px;
 font-size: 1.0rem;
 border: 1px solid #ddd;
 border-radius: var(--button-border-radius);
 font-family: 'Vazirmatn', Arial, sans-serif;
 cursor: pointer;
 transition: all 0.3s ease;
 text-align: center;
 }
 .form-button-row .dm-button {
 background-color: white;
 color: var(--dark-color);
 }
 .form-button-row .dm-button:hover {
 border-color: var(--primary-color);
 }
 .form-button-row .dm-button.active,
 #add-follower-modal #save-follower {
 background-color: var(--primary-color);
 color: white;
 border-color: var(--primary-color);
 }
 .alert-message {
 padding: 10px 15px;
 margin-top: 15px;
 border-radius: var(--button-border-radius);
 font-size: 0.95rem;
 font-weight: 500;
 text-align: center;
 display: none;
 border: 1px solid transparent;
 width: 100%;
 }
 .alert-message.error {
 background-color: #f8d7da;
 color: #721c24;
 border-color: #f5c6cb;
 }
 .alert-message.success {
 background-color: #d4edda;
 color: #155724;
 border-color: #c3e6cb;
 }
 .alert-message.info {
 background-color: var(--primary-light);
 color: var(--primary-color);
 border-color: var(--border-color);
 } 
 .modal {
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 height: 100%;
 background-color: rgba(0, 0, 0, 0.65);
 z-index: 2001;
 display: none;
 justify-content: center;
 align-items: center;
 padding: 0;
 }
 .modal-content {
 background-color: white;
 border-radius: var(--border-radius);
 padding: 30px;
 width: 90%;
 max-width: 600px;
 max-height: 90vh;
 overflow-y: auto;
 position: relative;
 box-shadow: var(--card-shadow);
 text-align: right;
 }
 /* استایل تمام صفحه برای Modal ها */
 #add-follower-modal .modal-content {
 width: 100vw;
 height: 100vh;
 max-width: 100vw;
 max-height: 100vh;
 border-radius: 0;
 padding: 25px;
 display: flex;
 flex-direction: column;
 justify-content: flex-start;
 align-items: center;
 overflow-y: auto;
 overflow-x: hidden;
 }
 #follower-details-modal .modal-content {
 width: 100vw;
 height: 100vh;
 max-width: 100vw;
 max-height: 100vh;
 border-radius: 0;
 padding: 25px;
 padding-bottom: 150px; /* فضای بیشتر برای دکمه پیگیری */
 overflow-y: auto;
 }
 /* اضافه شدن استایل برای مودال گزارشگیری */
 #message-iframe-modal .modal-content,
 #report-iframe-modal .modal-content { 
 width: 100vw;
 height: 100vh;
 max-width: 100vw;
 max-height: 100vh;
 border-radius: 0;
 padding: 0; /* پدینگ صفر برای iframe modal */
 display: flex;
 flex-direction: column;
 justify-content: flex-start;
 align-items: center;
 overflow: hidden; /* جلوگیری از اسکرول مودال اصلی */
 }

 #add-follower-modal .modal-body {
 display: flex;
 flex-direction: column;
 align-items: center;
 justify-content: flex-start;
 width: 100%;
 flex-grow: 1;
 padding: 0 10px;
 max-width: 600px;
 }
 /* START: CHANGE - Fixed form width consistency */
 #add-follower-modal form {
    width: 100%;
 }
 /* END: CHANGE */
 .modal-close {
 position: absolute;
 top: 15px;
 left: 20px;
 font-size: 28px;
 cursor: pointer;
 color: var(--grey-color);
 line-height: 1;
 font-weight: bold;
 border-radius: 50%;
 width: 40px;
 height: 40px;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 z-index: 2002; /* بالاتر از iframe */
 background-color: white; /* برای دیده شدن روی iframe */
 box-shadow: 0 2px 5px rgba(0,0,0,0.2);
 }
 .modal-title {
 font-size: 1.3rem;
 margin-bottom: 20px;
 padding-bottom: 15px;
 border-bottom: 1px solid var(--grey-light);
 color: var(--dark-color);
 }
 #add-follower-modal .modal-footer {
 display: none;
 }
 #confirm-message-modal .modal-footer, #confirm-remove-all-modal .modal-footer, #feedback-modal .modal-footer, #follower-details-modal .modal-footer {
 display: flex;
 justify-content: center;
 gap: 15px;
 padding-top: 15px;
 border-top: 1px solid var(--grey-light);
 }
 #follower-details-modal .modal-footer {
 padding-top: 20px;
 margin-top: 10px;
 position: absolute;
 bottom: 70px; /* بالاتر از دکمه بستن */
 left: 0;
 right: 0;
 background-color: white;
 padding-bottom: 20px;
 }
 #details-follow-up-btn {
 width: 80%;
 max-width: 300px;
 }

 .empty-state {
 text-align: center;
 padding: 40px 20px;
 color: var(--grey-color);
 }
 .empty-state i {
 font-size: 40px;
 margin-bottom: 15px;
 opacity: 0.5;
 }
 .check-time-info { /* این بخش از HTML حذف شده است */
 background-color: var(--primary-light);
 border: 1px solid var(--border-color);
 border-radius: var(--button-border-radius);
 padding: 12px;
 margin: 20px 0;
 text-align: center;
 font-size: 0.9rem;
 color: var(--grey-color);
 }
 .timer-display { /* این بخش از HTML حذف شده است */
 font-weight: 700;
 color: var(--primary-color);
 font-size: 1.2rem;
 }
 .timer-display.inactive { /* این بخش از HTML حذف شده است */
 color: var(--grey-color);
 }
 #follower-details-modal .modal-body {
 text-align: right;
 }
 #follower-details-modal .detail-item {
 display: flex;
 justify-content: space-between;
 align-items: center;
 margin-bottom: 1rem;
 padding-bottom: 1rem;
 border-bottom: 1px solid var(--grey-light);
 font-size: 1rem;
 flex-wrap: wrap;
 }
 #follower-details-modal .detail-label { 
 font-weight: 600; 
 color: var(--dark-color);
 background-color: var(--primary-light);
 padding: 4px 10px;
 border-radius: 6px;
 display: inline-block;
 }
 #follower-details-modal .detail-value { 
 font-weight: 500;
 text-align: left;
 }
 #follower-details-modal .detail-value .fa-check-circle {
 color: var(--success-color);
 }
 #follower-details-modal .detail-value .fa-times-circle {
 color: var(--danger-color);
 }
 #edit-follower-btn {
 position: absolute;
 top: 20px;
 left: 20px;
 font-size: 1rem;
 color: white;
 background-color: var(--success-color);
 cursor: pointer;
 z-index: 20;
 width: 40px;
 height: 40px;
 border-radius: 50%;
 display: flex;
 align-items: center;
 justify-content: center;
 }

 /* تغییر فونت دکمه بستن به وزیر */
 #follower-details-modal .modal-close {
 position: fixed;
 bottom: 20px;
 left: 50%;
 transform: translateX(-50%);
 top: auto;
 right: auto;
 height: 50px;
 width: auto;
 padding: 0 30px;
 background-color: var(--danger-color);
 color: white;
 border-radius: 12px;
 font-size: 1rem;
 font-weight: 600;
 box-shadow: 0 5px 15px rgba(0,0,0,0.2);
 z-index: 100;
 border: none;
 font-family: 'Vazirmatn', Arial, sans-serif; /* اضافه شدن فونت وزیر */
 }

 .content-section {
 display: none;
 }
 .content-section.active {
 display: block;
 }
 
 /* START: CHANGE - Hide redundant content sections */
 /* این بخش از CSS، تب‌های اضافی را مخفی می‌کند زیرا همه فالوورها در تب "همه فالوورها" نمایش داده می‌شوند. */
 #content-new_follower,
 #content-pending,
 #content-check_needed,
 #content-responded,
 #content-today_check,
 #content-no-response {
 display: none !important;
 }
 /* END: CHANGE */
 
 /* --- Close Friend Icon Styling --- */
 .ig-style-cf-icon {
 display: inline-flex;
 align-items: center;
 justify-content: center;
 width: 22px;
 height: 22px;
 background-color: var(--success-color);
 border-radius: 50%;
 color: white;
 flex-shrink: 0;
 vertical-align: middle;
 transition: var(--transition);
 position: relative;
 }
 .ig-style-cf-icon .fa-star {
 font-size: 11px;
 line-height: 1;
 position: absolute;
 top: 50%;
 left: 50%;
 transform: translate(-50%, -50%);
 }
 /* Icon next to username in list */
 .follower-username-row .ig-style-cf-icon {
 width: 18px;
 height: 18px;
 }
 .follower-username-row .ig-style-cf-icon .fa-star {
 font-size: 9px;
 }
 /* Filter button in "Responded" tab */
 #filter-close-friends-btn {
 margin-bottom: 15px;
 background-color: var(--grey-light);
 border: 1px solid var(--border-color);
 width: auto;
 padding: 8px 15px;
 font-family: 'Vazirmatn', Arial, sans-serif;
 font-weight: 500;
 }
 #filter-close-friends-btn.active {
 background-color: var(--success-color);
 color: white;
 border-color: var(--success-color);
 }
 /* Modal "Yes" button for Close Friends */
 #feedback-q3-yes {
 gap: 10px;
 }
 #feedback-q3-yes .ig-style-cf-icon {
 width: 28px;
 height: 28px;
 }
 #feedback-q3-yes .ig-style-cf-icon .fa-star {
 font-size: 14px;
 }

 @media (max-width: 768px) {
 body { padding: 10px; }
 .stats-container { gap: 10px; flex-wrap: wrap;}
 .stat-card { min-width: calc(50% - 10px); }
 .stat-value { font-size: 1.4rem; }
 .action-button { width: 100%; }
 .follower-item { flex-direction: column; align-items: flex-start; gap: 10px; }
 .follower-actions { width: 100%; justify-content: flex-end; }
 #add-follower-modal .modal-content { padding: 15px; }
 #add-follower-modal form { max-width: 100%; }
 .form-button-row { flex-direction: row; }
 .main-controls .controls-button-row { flex-direction: row; }
 }
 </style>
</head>
<body>
 <div class="stats-container">
 <div class="stat-card active" data-status-filter="all"><div class="stat-value" id="total-followers">0</div><div class="stat-label">همه فالوورها</div></div>
 <div class="stat-card" data-status-filter="new_follower"><div class="stat-value" id="new_follower-followers">0</div><div class="stat-label">فالوورهای جدید</div></div>
 <div class="stat-card" data-status-filter="pending"><div class="stat-value" id="pending-followers">0</div><div class="stat-label">در انتظار پاسخ</div></div>
 <div class="stat-card" data-status-filter="check_needed"><div class="stat-value" id="check_needed-followers">0</div><div class="stat-label">نیازمند بررسی</div></div>
 <div class="stat-card" data-status-filter="responded"><div class="stat-value" id="responded-followers">0</div><div class="stat-label">پاسخ داده‌اند</div></div>
 <div class="stat-card" data-status-filter="today_check"><div class="stat-value" id="today_check-followers">0</div><div class="stat-label">بررسی‌های امروز</div></div>
 <div class="stat-card" data-status-filter="no-response"><div class="stat-value" id="remove-followers">0</div><div class="stat-label">آماده حذف</div></div>
 </div>
 <div class="controls-header">
 <div class="sort-controls">
 <select id="sort-order">
 <option value="newestFirst">جدید به قدیمی</option>
 <option value="oldestFirst">قدیمی به جدید</option>
 <option value="usernameAsc">نام کاربری (صعودی)</option>
 <option value="usernameDesc">نام کاربری (نزولی)</option>
 </select>
 </div>
 </div>
 <div class="main-controls">
 <div class="controls-button-row"> <!-- ردیف جدید برای دکمه‌های "افزودن فالوور جدید" و "گزارشگیری" -->
 <button class="action-button primary" id="add-followers-btn"><i class="fas fa-user-plus"></i> افزودن فالوور جدید</button>
 <button class="action-button primary" id="report-btn"><i class="fas fa-chart-bar"></i> گزارشگیری</button>
 </div>
 <div class="controls-button-row">
 <button class="action-button primary" id="backup-btn"><i class="fas fa-download"></i> پشتیبان‌گیری</button>
 <button class="action-button primary" id="restore-btn"><i class="fas fa-upload"></i> بازگردانی</button>
 <input type="file" id="restore-file-input" style="display: none;" accept=".json">
 <button class="action-button primary" id="message-btn"><i class="fas fa-envelope"></i> پیام</button>
 </div> 
 </div>
 <div id="add-follower-alert" class="alert-message" style="display: none;"></div>
 <!-- بخش check-time-info (نمایش تایمر) حذف شده است -->
 <div class="content-section active" id="content-all">
 <input type="text" id="search-followers" placeholder="جستجوی فالوور...">
 <!-- این دکمه فیلتر فقط زمانی نمایش داده می‌شود که فیلتر "پاسخ داده" فعال باشد -->
 <button id="filter-close-friends-btn" class="action-button" style="display: none;">فقط Close Friends</button>
 <div class="follower-list" id="follower-list-all">
 <div class="empty-state"><i class="fas fa-users"></i><p>فالووری ثبت نشده.</p></div>
 </div>
 <div class="form-group" style="text-align: center; margin-top: 30px;">
 <button class="action-button danger" id="remove-all" disabled><i class="fas fa-trash-alt"></i> حذف فالوورهای آماده حذف</button>
 </div>
 </div>
 <!-- START: CHANGE - These content sections are now hidden via CSS -->
 <div class="content-section" id="content-new_follower">
 <h4><i class="fas fa-user-clock"></i> فالوورهای جدید</h4>
 <p style="text-align: right; color: var(--grey-color); margin-bottom: 15px; font-size: 0.9rem;">این فالوورها به مدت ۳ ماه در این لیست باقی می‌مانند.</p>
 <div class="follower-list" id="follower-list-new_follower"></div>
 </div>
 <div class="content-section" id="content-pending">
 <h4><i class="fas fa-hourglass-half"></i> در انتظار پاسخ</h4>
 <p style="text-align: right; color: var(--grey-color); margin-bottom: 15px; font-size: 0.9rem;">مهلت: <span id="pending-deadline-days">7</span> روز. بازخورد را ثبت کنید.</p>
 <div class="follower-list" id="follower-list-pending"></div>
 </div>
 <div class="content-section" id="content-check_needed">
 <h4><i class="fas fa-user-check"></i> نیازمند بررسی</h4>
 <p style="text-align: right; color: var(--grey-color); margin-bottom: 15px; font-size: 0.9rem;">پاسخ نداده و پیام را دیده‌اند. در لیست "بررسی‌های امروز" مدیریت کنید.</p>
 <div class="follower-list" id="follower-list-check_needed"></div>
 </div>
 <div class="content-section" id="content-responded">
 <h4><i class="fas fa-user-graduate"></i> پاسخ داده‌اند</h4>
 <div class="follower-list" id="follower-list-responded"></div>
 </div>
 <div class="content-section" id="content-today_check">
 <h4><i class="fas fa-calendar-check"></i> بررسی‌های امروز</h4>
 <p style="text-align: right; color: var(--grey-color); margin-bottom: 15px; font-size: 0.9rem;">مهلت ۶ روزه این فالوورها برای بررسی به پایان رسیده است.</p>
 <div class="follower-list" id="follower-list-today_check"></div>
 </div>
 <div class="content-section" id="content-no-response">
 <h4><i class="fas fa-user-slash"></i> آماده حذف</h4>
 <p style="text-align: right; color: var(--grey-color); margin-bottom: 15px; font-size: 0.9rem;">پاسخ نداده و پیام را ندیده‌اند یا دستی از لیست بررسی حذف شده‌اند.</p>
 <div class="follower-list" id="follower-list-no-response"></div>
 </div>
 <!-- END: CHANGE -->

 <!-- Modals -->
 <div class="modal" id="add-follower-modal">
 <div class="modal-content">
 <div class="modal-body">
 <form>
 <h3 class="modal-title" id="add-edit-modal-title" style="width: 100%; text-align: center;">افزودن فالوور جدید</h3>
 <div class="form-group">
 <label>آیا تازه فالو کرده؟</label>
 <div class="form-button-row">
 <button type="button" class="dm-button active" id="new-follow-no">خیر</button>
 <button type="button" class="dm-button" id="new-follow-yes">بله</button>
 </div>
 </div>
 <div class="form-group">
 <label for="new-follower-username">نام کاربری:</label>
 <input type="text" id="new-follower-username" placeholder="مثال: amlak.moein" title="فقط حروف انگلیسی، اعداد، نقطه و آندرلاین مجاز است">
 </div>
 <div class="form-group">
 <label for="new-follower-name">Name:</label>
 <input type="text" id="new-follower-name" placeholder="مثال: املاک معین رامسر" maxlength="150" title="حداکثر 150 کارکтер">
 </div>

 <!-- START: CHANGE - فیلد تاریخ فالو کردن به اینجا منتقل شد تا همیشه نمایش داده شود -->
 <div class="form-group" id="follow-date-group">
    <label for="new-follower-follow-date">تاریخ دنبال کردن:</label>
    <input type="text" id="new-follower-follow-date" placeholder="مثال: Jul 2023">
 </div>
 <!-- END: CHANGE -->

 <div id="advanced-follower-fields">
 <div class="form-button-row">
 <div class="form-group">
 <label for="new-follower-likes" class="instagram-emoji-label"><span class="instagram-like-emoji">❤️</span>تعداد لایک‌ها:</label>
 <input type="number" id="new-follower-likes" placeholder="2">
 </div>
 <div class="form-group">
 <label for="new-follower-comments" class="instagram-emoji-label"><span class="instagram-comment-emoji">💬</span>تعداد کامنت‌ها:</label>
 <input type="number" id="new-follower-comments" placeholder="1">
 </div>
 </div>

 <!-- START: CHANGE - ردیف تاریخ‌ها اصلاح شد چون تاریخ فالو کردن به بیرون منتقل شد -->
 <div class="form-group">
    <label for="new-follower-last-post-date">تاریخ آخرین پست:</label>
    <input type="text" id="new-follower-last-post-date" placeholder="مثال: Aug 2023">
 </div>
 <!-- END: CHANGE -->

 <div class="form-button-row">
 <div class="form-group">
 <label for="new-follower-followings">تعداد فالویینگ‌ها:</label>
 <input type="number" id="new-follower-followings" placeholder="2500">
 </div>
 <div class="form-group">
 <label for="new-follower-posts">تعداد پست‌ها:</label>
 <input type="number" id="new-follower-posts" placeholder="19">
 </div>
 </div>
 <div class="form-group">
 <label>ارتباط در دایرکت:</label>
 <div class="form-button-row">
 <button type="button" class="dm-button active" id="dm-no-btn">خیر</button>
 <button type="button" class="dm-button" id="dm-yes-btn">بله</button>
 </div>
 </div>
 <div class="form-group" id="dm-interaction-details-group" style="display: none;">
 <label for="new-follower-dm-last-date">تاریخ آخرین ارتباط:</label>
 <input type="text" id="new-follower-dm-last-date" placeholder="مثال: Jul 2023">
 </div>
 </div>
 <div class="form-group">
 <label for="new-follower-description">توضیحات:</label>
 <textarea id="new-follower-description" rows="3" placeholder="نکات اضافی را اینجا وارد کنید..."></textarea>
 </div>
 <div id="add-follower-modal-alert" class="alert-message" style="display: none; width: 100%;"></div>
 <div class="form-group">
 <div class="form-button-row">
 <button type="button" class="action-button" id="save-follower">ذخیره</button>
 <button type="button" class="action-button danger modal-cancel">بستن</button>
 </div>
 </div>
 </form>
 </div>
 </div>
 </div>
 <div class="modal" id="follower-details-modal">
 <div class="modal-content">
 <i class="fas fa-pencil-alt" id="edit-follower-btn"></i>
 <button class="modal-close">بستن</button>
 <h3 class="modal-title">جزئیات: <span id="details-username-title"></span></h3>
 <div class="modal-body">
 <div class="detail-item"><span class="detail-label">نام کاربری</span><span class="detail-value" id="details-username"></span></div>
 <div class="detail-item"><span class="detail-label">Name</span><span class="detail-value" id="details-name"></span></div>
 <div class="detail-item"><span class="detail-label instagram-emoji-label"><span class="instagram-like-emoji">❤️</span>لایک‌ها</span><span class="detail-value" id="details-likes"></span></div>
 <div class="detail-item"><span class="detail-label instagram-emoji-label"><span class="instagram-comment-emoji">💬</span>کامنت‌ها</span><span class="detail-value" id="details-comments"></span></div>
 <div class="detail-item"><span class="detail-label">فالویینگ‌ها</span><span class="detail-value" id="details-followings"></span></div>
 <div class="detail-item"><span class="detail-label">پست‌ها</span><span class="detail-value" id="details-posts"></span></div>
 <div class="detail-item"><span class="detail-label">آخرین پست</span><span class="detail-value" id="details-last-post-date"></span></div>
 <div class="detail-item"><span class="detail-label">ارتباط دایرکت</span><span class="detail-value" id="details-dm-interacted"></span></div>
 <div class="detail-item" id="details-dm-last-date-item"><span class="detail-label">آخرین ارتباط</span><span class="detail-value" id="details-dm-last-date"></span></div>
 <div class="detail-item"><span class="detail-label">پیام ارسال شده</span><span class="detail-value" id="details-message-sent-status"></span></div>
 <div class="detail-item"><span class="detail-label">وضعیت</span><span class="detail-value" id="details-status"></span></div>
 <div class="detail-item" id="details-message-date-item"><span class="detail-label">تاریخ پیگیری</span><span class="detail-value" id="details-message-date"></span></div>
 <div class="detail-item" id="details-check-needed-date-item"><span class="detail-label">تاریخ نیاز بررسی</span><span class="detail-value" id="details-check-needed-date"></span></div>
 <div class="detail-item" id="details-response-date-item"><span class="detail-label">تاریخ پاسخ</span><span class="detail-value" id="details-response-date"></span></div>
 <div class="detail-item"><span class="detail-label">توضیحات</span><span class="detail-value" id="details-description"></span></div>
 <div id="system-description-section"><p id="system-description-text" style="margin-top: 15px; padding: 10px; background-color: var(--primary-light); border-radius: var(--button-border-radius); font-size: 0.9rem;"></p></div>
 </div>
 <div class="modal-footer" id="details-modal-footer">
 <button class="action-button primary" id="details-follow-up-btn" style="display: none;" onclick="handleFollowUpFromDetails()">پیگیری</button>
 </div>
 </div>
 </div>
 <div class="modal" id="confirm-message-modal">
 <div class="modal-content">
 <span class="modal-close">&times;</span>
 <h3 class="modal-title">تایید ارسال پیام</h3>
 <p>آیا به این فالوور پیام ارسال کرده‌اید؟</p>
 <div class="modal-footer">
 <button class="action-button success" id="confirm-message-yes">بله</button>
 <button class="action-button danger modal-cancel">خیر</button>
 </div>
 </div>
 </div>
 <div class="modal" id="feedback-modal">
 <div class="modal-content">
 <span class="modal-close">&times;</span>
 <h3 class="modal-title">ثبت بازخورد <span id="feedback-modal-username"></span></h3>
 <div id="feedback-question-1">
 <p>آیا فالوور پاسخ داد؟</p>
 <div class="modal-footer">
 <button class="action-button success" id="feedback-q1-yes">بله</button>
 <button class="action-button danger" id="feedback-q1-no">خیر</button>
 </div>
 </div>
 <div id="feedback-question-2" style="display:none;">
 <p>آیا پیام را مشاهده کرد؟</p>
 <div class="modal-footer">
 <button class="action-button success" id="feedback-q2-yes">بله</button>
 <button class="action-button danger" id="feedback-q2-no">خیر</button>
 </div>
 </div>
 <div id="feedback-question-likes-comments" style="display:none;">
 <p style="margin-bottom: 15px; font-weight: 500;">لطفاً تعداد لایک‌ها و کامنت‌های جدید را وارد کنید:</p>
 <div class="form-button-row">
 <div class="form-group" style="flex: 1;">
 <label for="feedback-new-likes" class="instagram-emoji-label"><span class="instagram-like-emoji">❤️</span>لایک‌ها:</label>
 <input type="number" id="feedback-new-likes" placeholder="0">
 </div>
 <div class="form-group" style="flex: 1;">
 <label for="feedback-new-comments" class="instagram-emoji-label"><span class="instagram-comment-emoji">💬</span>کامنت‌ها:</label>
 <input type="number" id="feedback-new-comments" placeholder="0">
 </div>
 </div>
 <div class="modal-footer" style="border-top: none; padding-top: 0;">
 <button class="action-button success" id="save-feedback-likes-comments">ثبت و ادامه</button>
 </div>
 </div>
 <div id="feedback-question-3" style="display:none;">
 <p>آیا توی کلوز فرند وارد کردیش؟</p>
 <div class="modal-footer">
 <button class="action-button success" id="feedback-q3-yes">بله</button>
 <button class="action-button danger" id="feedback-q3-no">خیر</button>
 </div>
 </div>
 </div>
 </div>
 <div class="modal" id="confirm-remove-modal">
 <div class="modal-content">
 <span class="modal-close">&times;</span>
 <h3 class="modal-title">تایید حذف</h3>
 <p>آیا از حذف <strong id="remove-username"></strong> اطمینان دارید؟</p>
 <div class="modal-footer">
 <button class="action-button danger" id="confirm-remove">حذف</button>
 <button class="action-button modal-cancel">انصراف</button>
 </div>
 </div>
 </div>
 <div class="modal" id="confirm-remove-all-modal">
 <div class="modal-content">
 <span class="modal-close">&times;</span>
 <h3 class="modal-title">تایید حذف گروهی</h3>
 <p id="confirm-remove-all-message"></p>
 <div class="modal-footer">
 <button class="action-button danger" id="confirm-remove-all-yes">بله، حذف شوند</button>
 <button class="action-button modal-cancel">انصراف</button>
 </div>
 </div>
 </div>
 <div class="modal" id="description-modal">
 <div class="modal-content">
 <span class="modal-close">&times;</span>
 <h3 class="modal-title">توضیحات برای <span id="description-modal-username"></span></h3>
 <textarea id="follower-description-text" rows="5" placeholder="نکات اضافی را اینجا وارد کنید..."></textarea>
 <div class="modal-footer">
 <button class="action-button success" id="save-description-btn">ذخیره</button>
 <button type="button" class="action-button danger modal-cancel">انصراف</button>
 </div>
 </div>
 </div>

 <!-- Modal جدید برای بارگذاری صفحه پیام فالوور در iframe -->
 <div class="modal" id="message-iframe-modal">
 <div class="modal-content" style="padding: 0; width: 100vw; height: 100vh; max-width: 100vw; max-height: 100vh; border-radius: 0;">
 <span class="modal-close" onclick="closeModal(document.getElementById('message-iframe-modal'))">&times;</span>
 <iframe id="follower-message-iframe" src="" frameborder="0" style="width: 100%; height: 100%; border: none;"></iframe>
 </div>
 </div>

 <!-- Modal جدید برای بارگذاری صفحه گزارشگیری در iframe -->
 <div class="modal" id="report-iframe-modal">
 <div class="modal-content">
 <span class="modal-close" onclick="closeModal(document.getElementById('report-iframe-modal'))">&times;</span>
 <iframe id="follower-report-iframe" src="" frameborder="0" style="width: 100%; height: 100%; border: none;"></iframe>
 </div>
 </div>

 <script> 
 // Constants
 const STATUS_NEW = "جدید";
 const STATUS_NEW_FOLLOWER = "فالوور جدید";
 const STATUS_PENDING = "در انتظار پاسخ";
 const STATUS_CHECK_NEEDED = "نیازمند بررسی";
 const STATUS_RESPONDED = "پاسخ داده";
 const STATUS_NO_RESPONSE = "آماده حذف";
 const STATUS_TODAY_CHECK = "بررسی امروز";
 const LOCAL_STORAGE_KEY = "fake-followers-data";
 const LOCAL_STORAGE_SETTINGS_KEY = "fake-followers-settings";
 const PENDING_DAYS = 7;
 
 // Global Variables
 let followers = [];
 let settings = { 
 pendingDays: 7,
 currentFilter: "all",
 isCloseFriendFilterActive: false
 };
 let currentSort = "newestFirst";
 let timerInterval = null;
 let editingFollowerId = null;
 let currentFollowerId = null;
 let dmInteractionValue = "no";
 let isNewFollowerMode = false;

 // DOM Elements
 let statCards;
 let followerLists;
 let contentSections;
 let addFollowerAlert;
 let addFollowerModalAlert;
 let pendingDeadlineDays;
 let dmInteractionDetailsGroup;
 let modals;
 let modalCloseButtons;
 let modalCancelButtons;

 function initializeDOMElements() {
 statCards = document.querySelectorAll(".stat-card");
 followerLists = {
 all: document.getElementById("follower-list-all"),
 };
 contentSections = document.querySelectorAll(".content-section");
 addFollowerAlert = document.getElementById("add-follower-alert");
 addFollowerModalAlert = document.getElementById("add-follower-modal-alert");
 pendingDeadlineDays = document.getElementById("pending-deadline-days");
 dmInteractionDetailsGroup = document.getElementById("dm-interaction-details-group");
 modals = document.querySelectorAll(".modal");
 modalCloseButtons = document.querySelectorAll(".modal-close");
 modalCancelButtons = document.querySelectorAll(".modal-cancel");
 }

 function setupEventListeners() {
 const backupBtn = document.getElementById("backup-btn");
 const restoreBtn = document.getElementById("restore-btn");
 const restoreFileInput = document.getElementById("restore-file-input");
 const addFollowersBtn = document.getElementById("add-followers-btn");
 const searchFollowers = document.getElementById("search-followers");
 const sortOrder = document.getElementById("sort-order");
 const removeAllBtn = document.getElementById("remove-all");
 const saveFollowerBtn = document.getElementById("save-follower");
 const confirmRemoveAllYes = document.getElementById("confirm-remove-all-yes");
 const confirmMessageYes = document.getElementById("confirm-message-yes");
 const feedbackQ1Yes = document.getElementById("feedback-q1-yes");
 const feedbackQ1No = document.getElementById("feedback-q1-no");
 const feedbackQ2Yes = document.getElementById("feedback-q2-yes");
 const feedbackQ2No = document.getElementById("feedback-q2-no");
 const saveDescriptionBtn = document.getElementById("save-description-btn");
 const confirmRemoveBtn = document.getElementById("confirm-remove");
 const newFollowerUsername = document.getElementById("new-follower-username");
 const dmYesBtn = document.getElementById("dm-yes-btn");
 const dmNoBtn = document.getElementById("dm-no-btn");
 const newFollowYes = document.getElementById("new-follow-yes");
 const newFollowNo = document.getElementById("new-follow-no");
 const editFollowerBtn = document.getElementById("edit-follower-btn");
 const feedbackQ3Yes = document.getElementById("feedback-q3-yes");
 const feedbackQ3No = document.getElementById("feedback-q3-no");
 const filterCloseFriendsBtn = document.getElementById("filter-close-friends-btn");
 const newFollowerName = document.getElementById("new-follower-name");
 const messageBtn = document.getElementById("message-btn");
 const reportBtn = document.getElementById("report-btn");
 const saveFeedbackLikesComments = document.getElementById("save-feedback-likes-comments");

 // Stat cards event listeners
 statCards.forEach(card => {
 card.addEventListener("click", function() {
 setActiveFilter(this.dataset.statusFilter);
 });
 });

 // Sort and search event listeners
 if (sortOrder) {
 sortOrder.addEventListener("change", function() {
 currentSort = this.value;
 updateFollowerLists();
 });
 }

 if (searchFollowers) {
 searchFollowers.addEventListener("input", updateFollowerLists);
 }

 // Main button event listeners
 if (addFollowersBtn) {
 addFollowersBtn.addEventListener("click", () => openAddFollowerModal());
 }

 if (saveFollowerBtn) {
 saveFollowerBtn.addEventListener("click", saveFollower);
 }

 // New follower form toggles
 if (newFollowYes) {
 newFollowYes.addEventListener("click", () => toggleNewFollowerForm(true));
 }

 if (newFollowNo) {
 newFollowNo.addEventListener("click", () => toggleNewFollowerForm(false));
 }

 // DM interaction buttons
 if (dmYesBtn && dmNoBtn) {
 dmYesBtn.addEventListener("click", function() {
 dmInteractionValue = "yes";
 dmYesBtn.classList.add("active");
 dmNoBtn.classList.remove("active");
 if (dmInteractionDetailsGroup) {
 dmInteractionDetailsGroup.style.display = "block";
 }
 });

 dmNoBtn.addEventListener("click", function() {
 dmInteractionValue = "no";
 dmNoBtn.classList.add("active");
 dmYesBtn.classList.remove("active");
 if (dmInteractionDetailsGroup) {
 dmInteractionDetailsGroup.style.display = "none";
 }
 });
 }

 // Remove all button
 if (removeAllBtn) {
 removeAllBtn.addEventListener("click", () => {
 const noResponseCount = followers.filter(f => f.status === STATUS_NO_RESPONSE).length;
 if (noResponseCount > 0) {
 document.getElementById("confirm-remove-all-message").textContent = 
 `آیا از حذف ${noResponseCount} فالوور آماده حذف اطمینان دارید؟`;
 openModal(document.getElementById("confirm-remove-all-modal"));
 }
 });
 }

 if (confirmRemoveAllYes) {
 confirmRemoveAllYes.addEventListener("click", () => {
 removeAllNoResponseFollowers();
 closeModal(document.getElementById("confirm-remove-all-modal"));
 });
 }

 // Message confirmation
 if (confirmMessageYes) {
 confirmMessageYes.addEventListener("click", confirmMessageSent);
 }

 // Feedback buttons
 if (feedbackQ1Yes) {
 feedbackQ1Yes.addEventListener("click", () => {
 document.getElementById("feedback-question-1").style.display = "none";
 document.getElementById("feedback-question-likes-comments").style.display = "block";
 });
 }

 if (feedbackQ1No) {
 feedbackQ1No.addEventListener("click", () => {
 document.getElementById("feedback-question-1").style.display = "none";
 document.getElementById("feedback-question-2").style.display = "block";
 });
 }

 if (feedbackQ2Yes) {
 feedbackQ2Yes.addEventListener("click", () => handleFeedbackNoResponse(true));
 }

 if (feedbackQ2No) {
 feedbackQ2No.addEventListener("click", () => handleFeedbackNoResponse(false));
 }

 if (feedbackQ3Yes) {
 feedbackQ3Yes.addEventListener("click", () => handleCloseFriendDecision(true));
 }

 if (feedbackQ3No) {
 feedbackQ3No.addEventListener("click", () => handleCloseFriendDecision(false));
 }

 // Close friends filter
 if (filterCloseFriendsBtn) {
 filterCloseFriendsBtn.addEventListener("click", function() {
 settings.isCloseFriendFilterActive = !settings.isCloseFriendFilterActive;
 this.classList.toggle("active", settings.isCloseFriendFilterActive);
 saveSettingsToStorage();
 updateFollowerLists();
 });
 }

 // Description and remove buttons
 if (saveDescriptionBtn) {
 saveDescriptionBtn.addEventListener("click", saveDescription);
 }

 if (confirmRemoveBtn) {
 confirmRemoveBtn.addEventListener("click", confirmRemoveFollower);
 }

 // Edit button
 if (editFollowerBtn) {
 editFollowerBtn.addEventListener("click", () => {
 closeModal(document.getElementById("follower-details-modal"));
 openAddFollowerModal(currentFollowerId);
 });
 }

 // Modal close buttons
 modalCloseButtons.forEach(btn => {
 btn.addEventListener("click", function() {
 closeModal(this.closest(".modal"));
 });
 });

 modalCancelButtons.forEach(btn => {
 btn.addEventListener("click", function() {
 closeModal(this.closest(".modal"));
 });
 });

 // Modal background click
 modals.forEach(modal => {
 modal.addEventListener("click", function(e) {
 if (e.target === modal) {
 closeModal(modal);
 }
 });
 });

 // Username input validation
 if (newFollowerUsername) {
 newFollowerUsername.addEventListener("input", function() {
 this.value = this.value.replace(/[^a-zA-Z0-9._]/g, "")
 .replace(/\.{2,}/g, ".")
 .replace(/^[.]/, "");
 });
 }

 // Name input direction detection
 if (newFollowerName) {
 newFollowerName.addEventListener("input", function() {
 const value = this.value;
 if (/[\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFF]/.test(value)) {
 this.style.direction = "rtl";
 this.style.textAlign = "right";
 } else {
 this.style.direction = "ltr";
 this.style.textAlign = "left";
 }
 });
 }

 // Backup and Restore
 if (backupBtn) {
 backupBtn.addEventListener("click", handleBackup);
 }

 if (restoreBtn) {
 restoreBtn.addEventListener("click", () => restoreFileInput.click());
 }

 if (restoreFileInput) {
 restoreFileInput.addEventListener("change", handleRestore);
 }

 // Message and Report buttons
 if (messageBtn) {
 messageBtn.addEventListener("click", openFollowerMessagePage);
 }

 if (reportBtn) {
 reportBtn.addEventListener("click", openFollowerReportPage);
 }

 // Save feedback likes/comments
 if (saveFeedbackLikesComments) {
 saveFeedbackLikesComments.addEventListener("click", () => {
 const follower = followers.find(f => f.id === currentFollowerId);
 if (!follower) return;

 const newLikesInput = document.getElementById("feedback-new-likes");
 const newCommentsInput = document.getElementById("feedback-new-comments");

 const newLikes = parseInt(newLikesInput.value) || 0;
 const newComments = parseInt(newCommentsInput.value) || 0;

 follower.likes = (follower.likes || 0) + newLikes;
 follower.comments = (follower.comments || 0) + newComments;

 newLikesInput.value = "";
 newCommentsInput.value = "";

 document.getElementById("feedback-question-likes-comments").style.display = "none";
 document.getElementById("feedback-question-3").style.display = "block";
 });
 }
 }

 // Initialize when DOM is loaded
 document.addEventListener("DOMContentLoaded", function() {
 loadFollowersFromStorage();
 performScheduledCheck(); //  بررسی وضعیت‌ها در زمان بارگذاری صفحه
 loadSettingsFromStorage();
 initializeDOMElements();
 updateStats();
 setActiveFilter(settings.currentFilter);
 updateUIBasedOnSettings();
 
 if (pendingDeadlineDays) {
 pendingDeadlineDays.textContent = settings.pendingDays || 7;
 }
 
 setupEventListeners();
 
 const searchInput = document.getElementById("search-followers");
 if (searchInput) {
 searchInput.value = "";
 }
 
 resetDailyMessageCountIfNeeded();

 // Message listener for iframe communication
 window.addEventListener('message', function(event) {
 if (event.data && event.data.type === 'requestFollowersData') {
 event.source.postMessage({ type: 'followersData', payload: followers }, event.origin);
 }
 if (event.data && event.data.type === 'followerUpdate') {
 const updatedFollower = event.data.payload;
 const index = followers.findIndex(f => f.id === updatedFollower.id);
 if (index !== -1) {
 followers[index] = updatedFollower;
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 }
 }
 if (event.data && event.data.type === 'followerAdded') {
 followers.push(event.data.payload);
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 }
 if (event.data && event.data.type === 'followerRemoved') {
 const removedId = event.data.payload;
 followers = followers.filter(f => f.id !== removedId);
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 }
 });
 });

 // Toggle new follower form
 function toggleNewFollowerForm(isNew) {
 isNewFollowerMode = isNew;
 const advancedFields = document.getElementById("advanced-follower-fields");
 const followDateInput = document.getElementById("new-follower-follow-date");
 const yesBtn = document.getElementById("new-follow-yes");
 const noBtn = document.getElementById("new-follow-no");

 if (isNew) {
 advancedFields.style.display = "none";
 followDateInput.value = new Date().toLocaleDateString('en-CA'); // فرمت YYYY-MM-DD
 followDateInput.readOnly = true;
 yesBtn.classList.add("active");
 noBtn.classList.remove("active");
 } else {
 advancedFields.style.display = "block";
 followDateInput.value = "";
 followDateInput.readOnly = false;
 yesBtn.classList.remove("active");
 noBtn.classList.add("active");
 }
 }

 // Modal functions
 function openModal(modal) {
 if (modal) {
 modal.style.display = "flex";
 document.body.classList.add("modal-open");
 }
 }

 function closeModal(modal) {
 if (modal) {
 modal.style.display = "none";
 document.body.classList.remove("modal-open");
 
 if (modal.id === 'message-iframe-modal') {
 document.getElementById('follower-message-iframe').src = '';
 }
 if (modal.id === 'report-iframe-modal') {
 document.getElementById('follower-report-iframe').src = '';
 }
 
 resetModalContent(modal);
 
 const feedbackModal = document.getElementById("feedback-modal");
 if (feedbackModal) {
 document.getElementById("feedback-question-1").style.display = "block";
 document.getElementById("feedback-question-2").style.display = "none";
 document.getElementById("feedback-question-3").style.display = "none";
 document.getElementById("feedback-question-likes-comments").style.display = "none";
 }
 }
 }

 function resetModalContent(modal) {
 if (modal.id === "add-follower-modal") {
 resetAddFollowerModal();
 }
 }

 // Filter functions
 function setActiveFilter(filter) {
 settings.currentFilter = filter;
 statCards.forEach(card => {
 card.classList.toggle("active", card.dataset.statusFilter === filter);
 });

 const closeFriendBtn = document.getElementById('filter-close-friends-btn');
 if (filter === 'responded') {
 closeFriendBtn.style.display = 'inline-flex';
 closeFriendBtn.classList.toggle('active', settings.isCloseFriendFilterActive);
 } else {
 closeFriendBtn.style.display = 'none';
 settings.isCloseFriendFilterActive = false;
 closeFriendBtn.classList.remove('active');
 }

 saveSettingsToStorage();
 updateFollowerLists();
 }

 // Stats update
 function updateStats() {
 const stats = {
 all: followers.length,
 new_follower: followers.filter(f => f.status === STATUS_NEW_FOLLOWER).length,
 pending: followers.filter(f => f.status === STATUS_PENDING).length,
 check_needed: followers.filter(f => f.status === STATUS_CHECK_NEEDED).length,
 responded: followers.filter(f => f.status === STATUS_RESPONDED).length,
 today_check: followers.filter(f => f.status === STATUS_TODAY_CHECK).length,
 "no-response": followers.filter(f => f.status === STATUS_NO_RESPONSE).length
 };

 document.getElementById('total-followers').textContent = stats.all;
 document.getElementById('new_follower-followers').textContent = stats.new_follower;
 document.getElementById('pending-followers').textContent = stats.pending;
 document.getElementById('check_needed-followers').textContent = stats.check_needed;
 document.getElementById('responded-followers').textContent = stats.responded;
 document.getElementById('today_check-followers').textContent = stats.today_check;
 document.getElementById('remove-followers').textContent = stats['no-response'];

 const removeAllBtn = document.getElementById("remove-all");
 if (removeAllBtn) {
 removeAllBtn.disabled = stats["no-response"] === 0;
 }
 }

 // Update follower lists
 function updateFollowerLists() {
 const listContainer = followerLists['all'];
 if (!listContainer) return;

 let filteredFollowers = followers;

 // Filter by status
 const statusMap = {
 new_follower: STATUS_NEW_FOLLOWER,
 pending: STATUS_PENDING,
 check_needed: STATUS_CHECK_NEEDED,
 responded: STATUS_RESPONDED,
 today_check: STATUS_TODAY_CHECK,
 "no-response": STATUS_NO_RESPONSE
 };

 if (settings.currentFilter !== "all" && statusMap[settings.currentFilter]) {
 filteredFollowers = filteredFollowers.filter(f => f.status === statusMap[settings.currentFilter]);
 }

 // Filter for Close Friends
 if (settings.currentFilter === "responded" && settings.isCloseFriendFilterActive) {
 filteredFollowers = filteredFollowers.filter(f => f.isCloseFriend);
 }

 // Filter by search term
 const searchInput = document.getElementById("search-followers");
 const searchTerm = searchInput ? searchInput.value.toLowerCase() : "";
 if (searchTerm) {
 filteredFollowers = filteredFollowers.filter(f => 
 f.username.toLowerCase().includes(searchTerm) || 
 (f.name && f.name.toLowerCase().includes(searchTerm))
 );
 }

 // Sort
 filteredFollowers.sort((a, b) => {
 switch (currentSort) {
 case "newestFirst": return new Date(b.addedDate) - new Date(a.addedDate);
 case "oldestFirst": return new Date(a.addedDate) - new Date(b.addedDate);
 case "usernameAsc": return a.username.localeCompare(b.username);
 case "usernameDesc": return b.username.localeCompare(a.username);
 default: return 0;
 }
 });

 renderFollowerList(listContainer, filteredFollowers);
 }

 // Render follower list
 function renderFollowerList(container, followers) {
 container.innerHTML = "";
 
 if (followers.length === 0) {
 container.innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>فالووری برای نمایش وجود ندارد.</p></div>';
 } else {
 followers.forEach(follower => {
 container.appendChild(createFollowerElement(follower));
 });
 }
 }

 // Create follower element
 function createFollowerElement(follower) {
 const div = document.createElement("div");
 div.className = "follower-item";
 div.dataset.followerId = follower.id;
 
 const statusClass = getStatusClass(follower.status);
 let actions = "";

 // فالوورهایی که پاسخ داده‌اند نیازی به دکمه ارسال پیام ندارند
 if (follower.status === STATUS_RESPONDED) {
 actions = `
 <button class="list-action-button" onclick="showFollowerDetails('${follower.id}')">نمایش</button>
 <button class="list-action-button" onclick="removeFollower('${follower.id}')">حذف</button>
 `;
 } else {
 actions = `
 <button class="list-action-button" onclick="showFollowerDetails('${follower.id}')">نمایش</button>
 <button class="list-action-button" onclick="sendMessage('${follower.id}')">${follower.messageSent ? "پیگیری" : "ارسال پیام"}</button>
 <button class="list-action-button" onclick="removeFollower('${follower.id}')">حذف</button>
 `;
 }

 div.innerHTML = `
 <div class="follower-info-row">
 <div class="follower-avatar">${follower.username.charAt(0).toUpperCase()}</div>
 <div class="follower-details">
 <div class="follower-username-row">
 <span class="follower-username">${follower.username}</span>
 ${follower.isCloseFriend ? '<span class="ig-style-cf-icon"><i class="fas fa-star"></i></span>' : ""}
 ${follower.status === STATUS_NEW_FOLLOWER ? '<span class="follower-status-new-label"><i class="fas fa-star"></i>جدید</span>' : ""}
 </div>
 <div class="follower-name">${follower.name || "نام تنظیم نشده"}</div>
 </div>
 <span class="follower-status ${statusClass}">${follower.status}</span>
 </div>
 <div class="follower-actions">
 ${actions}
 </div>
 `;
 div.onclick = (e) => {
     if (e.target.tagName !== 'BUTTON') {
         showFollowerDetails(follower.id);
     }
 };
 return div;
 }

 // Get status class
 function getStatusClass(status) {
 const statusClasses = {
 [STATUS_NEW]: "status-new",
 [STATUS_NEW_FOLLOWER]: "status-new_follower",
 [STATUS_PENDING]: "status-pending",
 [STATUS_CHECK_NEEDED]: "status-check_needed",
 [STATUS_RESPONDED]: "status-responded",
 [STATUS_NO_RESPONSE]: "status-no-response",
 [STATUS_TODAY_CHECK]: "status-today_check"};
 return statusClasses[status] || "";
 }

 // Add/Edit follower modal
 function openAddFollowerModal(followerId = null) {
 editingFollowerId = followerId;
 const modal = document.getElementById("add-follower-modal");
 const title = document.getElementById("add-edit-modal-title");

 if (followerId) {
 const follower = followers.find(f => f.id === followerId);
 if (follower) {
 title.textContent = "ویرایش " + follower.username;
 populateEditForm(follower);
 }
 } else {
 title.textContent = "افزودن فالوور جدید";
 resetAddFollowerModal();
 }

 openModal(modal);
 }

 function populateEditForm(follower) {
 toggleNewFollowerForm(follower.status === STATUS_NEW_FOLLOWER);
 
 document.getElementById("new-follower-username").value = follower.username || "";
 document.getElementById("new-follower-name").value = follower.name || "";
 document.getElementById("new-follower-likes").value = follower.likes || "";
 document.getElementById("new-follower-comments").value = follower.comments || "";
 document.getElementById("new-follower-followings").value = follower.followings || "";
 document.getElementById("new-follower-posts").value = follower.posts || "";
 document.getElementById("new-follower-follow-date").value = follower.followDate || "";
 document.getElementById("new-follower-last-post-date").value = follower.lastPostDate || "";
 document.getElementById("new-follower-description").value = follower.description || "";

 const dmYesBtn = document.getElementById("dm-yes-btn");
 const dmNoBtn = document.getElementById("dm-no-btn");

 if (follower.dmInteracted) {
 dmInteractionValue = "yes";
 dmYesBtn.classList.add("active");
 dmNoBtn.classList.remove("active");
 dmInteractionDetailsGroup.style.display = "block";
 } else {
 dmInteractionValue = "no";
 dmNoBtn.classList.add("active");
 dmYesBtn.classList.remove("active");
 dmInteractionDetailsGroup.style.display = "none";
 }

 if (follower.dmInteracted) {
 document.getElementById("new-follower-dm-last-date").value = follower.dmLastDate || "";
 }
 }

 function resetAddFollowerModal() {
 const form = document.getElementById("add-follower-modal").querySelector("form");
 if (form) {
 form.reset();
 }

 toggleNewFollowerForm(false); // پیش‌فرض روی فالوور قدیمی
 dmInteractionValue = "no";

 const dmYesBtn = document.getElementById("dm-yes-btn");
 const dmNoBtn = document.getElementById("dm-no-btn");
 const newFollowYes = document.getElementById("new-follow-yes");
 const newFollowNo = document.getElementById("new-follow-no");

 if (dmYesBtn && dmNoBtn) {
 dmNoBtn.classList.add("active");
 dmYesBtn.classList.remove("active");
 }
 
  if (newFollowYes && newFollowNo) {
 newFollowNo.classList.add("active");
 newFollowYes.classList.remove("active");
 }


 if (dmInteractionDetailsGroup) {
 dmInteractionDetailsGroup.style.display = "none";
 }

 hideAlert(addFollowerModalAlert);
 }

 // Save follower
 function saveFollower() {
 const username = document.getElementById("new-follower-username").value.trim();
 
 if (!username) {
 return showAlert(addFollowerModalAlert, "نام کاربری الزامی است.", "error");
 }

 const existingFollower = followers.find(f => f.username.toLowerCase() === username.toLowerCase());
 if (existingFollower && (!editingFollowerId || existingFollower.id !== editingFollowerId)) {
 return showAlert(addFollowerModalAlert, "این نام کاربری قبلاً ثبت شده است.", "error");
 }

 let followerData;

 if (isNewFollowerMode) {
 followerData = {
 username: username,
 name: document.getElementById("new-follower-name").value.trim(),
 followDate: document.getElementById("new-follower-follow-date").value.trim(),
 description: document.getElementById("new-follower-description").value.trim(),
 status: STATUS_NEW_FOLLOWER,
 // فالوور جدید اطلاعات پیشرفته ندارد
 likes: 0, comments: 0, followings: 0, posts: 0, lastPostDate: '', dmInteracted: false, dmLastDate: ''
 };
 } else {
 followerData = {
 username: username,
 name: document.getElementById("new-follower-name").value.trim(),
 likes: parseInt(document.getElementById("new-follower-likes").value) || 0,
 comments: parseInt(document.getElementById("new-follower-comments").value) || 0,
 followings: parseInt(document.getElementById("new-follower-followings").value) || 0,
 posts: parseInt(document.getElementById("new-follower-posts").value) || 0,
 followDate: document.getElementById("new-follower-follow-date").value.trim(),
 lastPostDate: document.getElementById("new-follower-last-post-date").value.trim(),
 dmInteracted: dmInteractionValue === "yes",
 description: document.getElementById("new-follower-description").value.trim(),
 status: STATUS_NEW // فالوور قدیمی به صورت پیش‌فرض در وضعیت جدید (آماده ارسال پیام) قرار می‌گیرد
 };

 followerData.dmLastDate = followerData.dmInteracted ? 
 document.getElementById("new-follower-dm-last-date").value.trim() : "";
 }

 if (editingFollowerId) {
 const index = followers.findIndex(f => f.id === editingFollowerId);
 if (index !== -1) {
 const originalStatus = followers[index].status;
 followers[index] = { ...followers[index], ...followerData };
 // اگر وضعیت در فرم ویرایش تغییر نکرده باشد، وضعیت قبلی را حفظ کن
 if (followerData.status === STATUS_NEW && originalStatus !== STATUS_NEW_FOLLOWER) {
     followers[index].status = originalStatus;
 }
 showAlert(addFollowerAlert, `فالوور ${username} ویرایش شد.`, "success");
 }
 } else {
 followerData.id = generateUniqueId();
 followerData.addedDate = new Date().toISOString();
 followerData.messageSent = false;
 followerData.isCloseFriend = false;
 followers.push(followerData);
 showAlert(addFollowerAlert, `فالوور ${username} اضافه شد.`, "success");
 }

 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 closeModal(document.getElementById("add-follower-modal"));
 editingFollowerId = null;
 }

 // Scheduled check function
 function performScheduledCheck() {
 let changedCount = 0;
 const threeMonthsAgo = 90 * 24 * 60 * 60 * 1000;
 const sevenDaysAgo = 7 * 24 * 60 * 60 * 1000;
 const now = new Date();
 const nowTime = now.getTime();

 followers.forEach(follower => {
 // منطق ۱: انتقال از "در انتظار پاسخ" به "بررسی امروز" پس از ۷ روز
 if (follower.status === STATUS_PENDING && follower.messageDate && 
 (nowTime - new Date(follower.messageDate).getTime() > sevenDaysAgo)) {
 follower.status = STATUS_TODAY_CHECK;
 changedCount++;
 }

 // منطق ۲: انتقال از "نیازمند بررسی" به "بررسی امروز" پس از ۷ روز
 if (follower.status === STATUS_CHECK_NEEDED && follower.checkNeededStartDate &&
 (nowTime - new Date(follower.checkNeededStartDate).getTime()) > sevenDaysAgo) {
 follower.status = STATUS_TODAY_CHECK;
 delete follower.checkNeededStartDate; // پاک کردن تاریخ برای جلوگیری از تکرار
 changedCount++;
 }

 // منطق قدیمی برنامه: انتقال فالوور جدیدی که ۳ ماه به او پیام داده نشده
 if (follower.status === STATUS_NEW_FOLLOWER && follower.addedDate && 
 (nowTime - new Date(follower.addedDate).getTime()) > threeMonthsAgo && !follower.messageSent) {
 follower.status = STATUS_TODAY_CHECK; // انتقال به بررسی امروز برای تصمیم‌گیری
 changedCount++;
 }
 });

 if (changedCount > 0) {
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 showAlert(addFollowerAlert, `${changedCount} فالوور به لیست بررسی امروز منتقل شدند.`, "info");
 }
 }


 // Send message function
 function sendMessage(followerId) {
 currentFollowerId = followerId;
 const follower = followers.find(f => f.id === followerId);
 
 if (!follower) return;

 // برای فالوورهای قدیمی و جدید که هنوز پیامی نگرفته‌اند
 if ((follower.status === STATUS_NEW || follower.status === STATUS_NEW_FOLLOWER) && !follower.messageSent) {
 openModal(document.getElementById("confirm-message-modal"));
 } 
 // برای فالوورهایی که در وضعیت‌های پیگیری هستند
 else if ([STATUS_PENDING, STATUS_CHECK_NEEDED, STATUS_TODAY_CHECK].includes(follower.status)) {
 document.getElementById("feedback-modal-username").textContent = follower.username;
 openModal(document.getElementById("feedback-modal"));
 } else {
 showAlert(addFollowerAlert, `عملیات برای فالوور در وضعیت "${follower.status}" مجاز نیست.`, "info");
 currentFollowerId = null;
 }
 }

 // Confirm message sent
 function confirmMessageSent() {
 const follower = followers.find(f => f.id === currentFollowerId);
 if (!follower) return;

 follower.messageSent = true;
 follower.status = STATUS_PENDING;
 follower.messageDate = new Date().toISOString(); // تاریخ ارسال پیام ثبت می‌شود

 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 closeModal(document.getElementById("confirm-message-modal"));
 showAlert(addFollowerAlert, `وضعیت ${follower.username} به "در انتظار پاسخ" تغییر یافت. مهلت پاسخ ۷ روز است.`, "success");
 currentFollowerId = null;
 }

 // Edit follower description
 function editFollowerDescription(followerId) {
 currentFollowerId = followerId;
 const follower = followers.find(f => f.id === followerId);
 
 if (follower) {
 document.getElementById("description-modal-username").textContent = follower.username;
 document.getElementById("follower-description-text").value = follower.description || "";
 openModal(document.getElementById("description-modal"));
 }
 }

 // Save description
 function saveDescription() {
 const follower = followers.find(f => f.id === currentFollowerId);
 
 if (follower) {
 follower.description = document.getElementById("follower-description-text").value.trim();
 saveFollowersToStorage();
 showAlert(addFollowerAlert, `توضیحات ${follower.username} ذخیره شد.`, "success");
 closeModal(document.getElementById("description-modal"));
 currentFollowerId = null;
 }
 }

 // Remove follower
 function removeFollower(followerId) {
 currentFollowerId = followerId;
 const follower = followers.find(f => f.id === followerId);
 
 if (follower) {
 document.getElementById("remove-username").textContent = follower.username;
 openModal(document.getElementById("confirm-remove-modal"));
 }
 }

 // Confirm remove follower
 function confirmRemoveFollower() {
 const followerIndex = followers.findIndex(f => f.id === currentFollowerId);
 
 if (followerIndex !== -1) {
 const follower = followers[followerIndex];
 followers.splice(followerIndex, 1);
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 showAlert(addFollowerAlert, `فالوور ${follower.username} با موفقیت حذف شد.`, "success");
 }
 
 closeModal(document.getElementById("confirm-remove-modal"));
 currentFollowerId = null;
 }

 // Remove all no-response followers
 function removeAllNoResponseFollowers() {
 const initialCount = followers.length;
 followers = followers.filter(f => f.status !== STATUS_NO_RESPONSE);
 const removedCount = initialCount - followers.length;

 if (removedCount > 0) {
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 showAlert(addFollowerAlert, `${removedCount} فالوور حذف شدند.`, "success");
 }
 }

 // Show follower details
 function showFollowerDetails(followerId) {
 const follower = followers.find(f => f.id === followerId);
 if (!follower) return;

 currentFollowerId = followerId;

 const followUpBtn = document.getElementById('details-follow-up-btn');
 // دکمه پیگیری فقط برای وضعیت‌های مشخصی نمایش داده می‌شود
 if ([STATUS_PENDING, STATUS_TODAY_CHECK, STATUS_CHECK_NEEDED].includes(follower.status)) {
 followUpBtn.style.display = 'inline-flex';
 } else {
 followUpBtn.style.display = 'none';
 }

 document.getElementById("details-username-title").textContent = follower.username;
 document.getElementById("details-username").textContent = follower.username;
 document.getElementById("details-name").textContent = follower.name || "---";
 document.getElementById("details-likes").textContent = follower.likes || 0;
 document.getElementById("details-comments").textContent = follower.comments || 0;
 document.getElementById("details-followings").textContent = follower.followings || 0;
 document.getElementById("details-posts").textContent = follower.posts || 0;
 document.getElementById("details-last-post-date").textContent = follower.lastPostDate || "---";

 const dmInteracted = document.getElementById("details-dm-interacted");
 const dmLastDateItem = document.getElementById("details-dm-last-date-item");

 if (follower.dmInteracted) {
 dmInteracted.innerHTML = '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> بله</span>';
 if (dmLastDateItem) {
 dmLastDateItem.style.display = "flex";
 }
 document.getElementById("details-dm-last-date").textContent = follower.dmLastDate || "---";
 } else {
 dmInteracted.innerHTML = '<span style="color: var(--danger-color);"><i class="fas fa-times-circle"></i> خیر</span>';
 if (dmLastDateItem) {
 dmLastDateItem.style.display = "none";
 }
 }

 const messageSentStatus = document.getElementById("details-message-sent-status");
 if (messageSentStatus) {
 messageSentStatus.innerHTML = follower.messageSent ? 
 '<span style="color: var(--success-color);"><i class="fas fa-check-circle"></i> بله</span>' :
 '<span style="color: var(--danger-color);"><i class="fas fa-times-circle"></i> خیر</span>';
 }

 const statusElement = document.getElementById("details-status");
 if (statusElement) {
 statusElement.textContent = follower.status;
 statusElement.className = "detail-value " + getStatusClass(follower.status);
 }

 ["messageDate", "checkNeededDate", "responseDate"].forEach(field => {
 const item = document.getElementById(`details-${field.replace(/([A-Z])/g, "-$1").toLowerCase()}-item`);
 const value = document.getElementById(`details-${field.replace(/([A-Z])/g, "-$1").toLowerCase()}`);
 
 if (item && value) {
 item.style.display = follower[field] ? "flex" : "none";
 if (follower[field]) {
 value.textContent = formatDate(follower[field]);
 }
 }
 });

 const descriptionElement = document.getElementById("details-description");
 if (descriptionElement) {
 descriptionElement.textContent = follower.description || "---";
 }

 const systemDescription = document.getElementById("system-description-text");
 if (systemDescription) {
 systemDescription.innerHTML = generateSystemDescription(follower);
 }

 openModal(document.getElementById("follower-details-modal"));
 }

 // Generate system description
 function generateSystemDescription(follower) {
 let description = "";
 const highlight = (text, className) => 
 `<span class="status-highlight ${className}" style="font-weight: 600; color: var(--primary-color);">${text}</span>`;

 switch (follower.status) {
 case STATUS_NEW:
 description = `این فالوور ${highlight("قدیمی", "new")} است که به سیستم اضافه شده و هنوز پیامی برای او ارسال نشده است.`;
 break;
 case STATUS_NEW_FOLLOWER:
 description = `این ${highlight("فالوور جدید", "new_follower")} است. برای شروع فرآیند، یک پیام برای او ارسال کنید.`;
 break;
 case STATUS_PENDING:
 const remainingDays = calculateRemainingDays(new Date(new Date(follower.messageDate).getTime() + (7 * 24 * 60 * 60 * 1000)));
 description = `پیام اولیه ارسال شده و در حال ${highlight("انتظار پاسخ", "pending")} است. ${
 remainingDays > 0 ? 
 `${highlight(remainingDays + " روز", "next-step")} تا موعد بررسی باقی مانده است.` : 
 "موعد بررسی فرا رسیده است."
 }`;
 break;
 case STATUS_CHECK_NEEDED:
 const remainingCheckDays = calculateRemainingDays(new Date(new Date(follower.checkNeededStartDate).getTime() + (7 * 24 * 60 * 60 * 1000)));
 description = `این فالوور ${highlight("نیازمند بررسی", "check_needed")} است زیرا پاسخ نداده ولی پیام را مشاهده کرده است. تا ${highlight(remainingCheckDays + " روز دیگر", "next-step")} به لیست بررسی امروز منتقل خواهد شد.`;
 break;
 case STATUS_RESPONDED:
 description = `این فالوور ${highlight("پاسخ داده", "responded")} و فرآیند برای او با موفقیت به پایان رسیده است.`;
 break;
 case STATUS_TODAY_CHECK:
 description = `موعد بررسی این فالوور فرا رسیده و در لیست ${highlight("بررسی‌های امروز", "today_check")} قرار دارد. لطفاً بازخورد را ثبت کنید.`;
 break;
 case STATUS_NO_RESPONSE:
 description = `این فالوور ${highlight("آماده حذف", "no_response")} است زیرا به پیام پاسخ نداده و آن را مشاهده نکرده است.`;
 break;
 default:
 description = "وضعیت نامشخص.";
 }

 return description;
 }

 // Calculate remaining days
 function calculateRemainingDays(dateString) {
 if (!dateString) return 0;
 const timeDiff = new Date(dateString) - new Date();
 return Math.max(0, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)));
 }

 // Handle follow up from details
 function handleFollowUpFromDetails() {
 if (!currentFollowerId) return;
 closeModal(document.getElementById('follower-details-modal'));
 sendMessage(currentFollowerId);
 }

 // Update UI based on settings
 function updateUIBasedOnSettings() {
 const closeFriendBtn = document.getElementById('filter-close-friends-btn');
 if (closeFriendBtn) {
 closeFriendBtn.classList.toggle('active', settings.isCloseFriendFilterActive);
 if (settings.currentFilter === 'responded') {
 closeFriendBtn.style.display = 'inline-flex';
 } else {
 closeFriendBtn.style.display = 'none';
 }
 }
 }

 // Handle close friend decision
 function handleCloseFriendDecision(isCloseFriend) {
 if (!currentFollowerId) return;
 
 const follower = followers.find(f => f.id === currentFollowerId);
 if (follower) {
 follower.status = STATUS_RESPONDED;
 follower.responseDate = new Date().toISOString();
 follower.isCloseFriend = isCloseFriend;
 
 showAlert(addFollowerAlert, `${follower.username} به وضعیت "پاسخ داده" منتقل شد.`, "success");
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 closeModal(document.getElementById("feedback-modal"));
 currentFollowerId = null;
 }
 }

 // Handle feedback no response
 function handleFeedbackNoResponse(sawMessage) {
 if (!currentFollowerId) return;
 
 const follower = followers.find(f => f.id === currentFollowerId);
 if (follower) {
 // اگر پیام را دیده ولی پاسخ نداده -> نیازمند بررسی
 if (sawMessage) {
 follower.status = STATUS_CHECK_NEEDED;
 follower.checkNeededStartDate = new Date().toISOString(); // تاریخ شروع مهلت ۷ روزه دوم
 if (!follower.description) follower.description = "";
 follower.description += (follower.description ? "\n" : "") + 
 `یادداشت سیستم: در تاریخ ${formatDate(new Date())} پیام را دیده ولی پاسخ نداده.`;
 showAlert(addFollowerAlert, `${follower.username} به "نیازمند بررسی" منتقل شد.`, "info");
 } 
 // اگر پیام را ندیده و پاسخ هم نداده -> آماده حذف
 else {
 follower.status = STATUS_NO_RESPONSE;
 showAlert(addFollowerAlert, `${follower.username} به "آماده حذف" منتقل شد.`, "info");
 }
 
 saveFollowersToStorage();
 updateStats();
 updateFollowerLists();
 closeModal(document.getElementById("feedback-modal"));
 currentFollowerId = null;
 }
 }

 // Format date function
 function formatDate(dateInput) {
 if (!dateInput) return "---";
 return new Date(dateInput).toLocaleDateString("fa-IR", {
 year: "numeric",
 month: "2-digit",
 day: "2-digit",
 hour: "2-digit",
 minute: "2-digit"
 });
 }

 // Generate unique ID
 function generateUniqueId() {
 return Date.now().toString(36) + Math.random().toString(36).substr(2);
 }

 // Show alert
 function showAlert(element, message, type = "info") {
 if (element) {
 element.textContent = message;
 element.className = `alert-message ${type}`;
 element.style.display = "block";
 setTimeout(() => element.style.display = "none", 5000);
 }
 }

 // Hide alert
 function hideAlert(element) {
 if (element) {
 element.style.display = "none";
 }
 }

 // Storage functions
 function saveFollowersToStorage() {
 localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(followers));
 }

 function loadFollowersFromStorage() {
 let loadedFollowers = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || "[]");
 followers = loadedFollowers.map(f => ({
 ...f,
 isCloseFriend: f.isCloseFriend || false
 }));
 }

 function saveSettingsToStorage() {
 localStorage.setItem(LOCAL_STORAGE_SETTINGS_KEY, JSON.stringify({
 pendingDays: settings.pendingDays,
 currentFilter: settings.currentFilter,
 isCloseFriendFilterActive: settings.isCloseFriendFilterActive
 }));
 }

 function loadSettingsFromStorage() {
 const loadedSettings = JSON.parse(localStorage.getItem(LOCAL_STORAGE_SETTINGS_KEY) || "{}");
 settings = {
 ...settings,
 ...loadedSettings
 };
 }

 // Reset daily message count
 function resetDailyMessageCountIfNeeded() {
 const today = new Date();
 const lastResetDate = localStorage.getItem("last-reset-date");
 const todayString = today.toDateString();
 
 if (lastResetDate !== todayString) {
 localStorage.setItem("last-reset-date", todayString);
 }
 }

 // Open follower message page
 function openFollowerMessagePage() {
 const iframeModal = document.getElementById('message-iframe-modal');
 const iframe = document.getElementById('follower-message-iframe');
 iframe.src = 'follower_message.html';
 openModal(iframeModal);
 }

 // Open follower report page
 function openFollowerReportPage() {
 const iframeModal = document.getElementById('report-iframe-modal');
 const iframe = document.getElementById('follower-report-iframe');
 iframe.src = 'follower_report.html';
 openModal(iframeModal);
 }

 // Backup and Restore Functions
 function handleBackup() {
 try {
 const backupData = {
 followers: followers,
 settings: settings,
 backupDate: new Date().toISOString(),
 dataType: 'followerManager'
 };

 const jsonString = JSON.stringify(backupData, null, 2);
 const blob = new Blob([jsonString], { type: 'application/json' });
 const url = URL.createObjectURL(blob);

 const a = document.createElement('a');
 const date = new Date().toISOString().split('T')[0];
 a.href = url;
 a.download = `follower_backup_${date}.json`;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 URL.revokeObjectURL(url);

 showAlert(addFollowerAlert, 'فایل پشتیبان با موفقیت دانلود شد.', 'success');
 } catch (error) {
 console.error('Backup failed:', error);
 showAlert(addFollowerAlert, 'خطا در تهیه فایل پشتیبان.', 'error');
 }
 }

 function handleRestore(event) {
 const file = event.target.files[0];
 if (!file) return;

 const reader = new FileReader();
 reader.onload = function(e) {
 try {
 const restoredData = JSON.parse(e.target.result);

 if (!restoredData.followers || !restoredData.settings || restoredData.dataType !== 'followerManager') {
 throw new Error('فایل پشتیبان نامعتبر است یا برای این برنامه نیست.');
 }

 if (confirm('آیا مطمئن هستید؟ با بازگردانی اطلاعات، تمام داده‌های فعلی شما پاک شده و اطلاعات فایل پشتیبان جایگزین خواهد شد.')) {
 followers = restoredData.followers;
 settings = restoredData.settings;

 saveFollowersToStorage();
 saveSettingsToStorage();
 location.reload(); // صفحه را برای اعمال کامل تغییرات رفرش می‌کنیم
 }
 } catch (error) {
 console.error('Restore failed:', error);
 showAlert(addFollowerAlert, error.message, 'error');
 } finally {
 event.target.value = null;
 }
 };
 reader.readAsText(file);
 }

 </script>
</body>
</html>