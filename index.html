<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 
 <!-- START: کد ضد کش اضافه شده (برای اطمینان از تازگی HTML) -->
 <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
 <meta http-equiv="Pragma" content="no-cache" />
 <meta http-equiv="Expires" content="0" />
 <!-- END: کد ضد کش اضافه شده -->

 <title>رادار اینستاگرام</title>
 
 <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700&display=swap" rel="stylesheet">
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
 
 <!-- START: اضافه شده برای نمایش favicon.ico -->
 <!-- این فرض را بر این می‌گذارد که فایل favicon.ico در پوشه images قرار دارد. -->
 <link rel="icon" href="images/favicon.ico" type="image/x-icon">
 <!-- END: اضافه شده برای نمایش favicon.ico -->

 <style>
 :root {
 --primary-color: #00D968;
 --primary-light: #E6F8EE; 
 --secondary-color: #00B84B;
 --dark-color: #333;
 --light-color: #f8f9fa; 
 --shadow: 0 10px 30px rgba(0, 217, 104, 0.1);
 --transition: all 0.3s ease;
 --gradient: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
 --card-shadow: 0 15px 35px rgba(0, 217, 104, 0.1), 0 5px 15px rgba(0, 0, 0, 0.07);
 --subtle-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
 --border-radius: 16px;
 --button-border-radius: 8px; 
 --border-color: #e0e0e0;
 --grey-color: #6c757d;
 --danger-color: #e74c3c;
 --text-color: #333333; 
 --text-light: #666666; 
 --bg-color: #f9f9f9; 
 --white: #ffffff; 
 }

 .payment-notification {
 position: fixed;
 top: -150px;
 left: 50%;
 transform: translateX(-50%);
 width: 90%;
 max-width: 450px;
 background-color: var(--white);
 border-radius: var(--border-radius);
 box-shadow: var(--card-shadow);
 display: flex;
 align-items: center;
 padding: 16px 20px;
 z-index: 10001;
 transition: top 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
 border-top: 4px solid;
 font-family: 'Vazirmatn', Arial, sans-serif;
 }

 .payment-notification.show {
 top: 20px;
 }

 .payment-notification.success { border-color: var(--primary-color); }
 .payment-notification.failed { border-color: var(--danger-color); }

 .notification-content strong {
 font-size: 16px;
 font-weight: 700;
 color: var(--dark-color);
 display: block;
 }
 .notification-content p {
 font-size: 14px;
 color: var(--grey-color);
 margin: 0;
 line-height: 1.5;
 }

 .notification-close {
 margin-right: auto;
 background: none;
 border: none;
 font-size: 24px;
 color: var(--grey-color);
 cursor: pointer;
 padding: 0 5px;
 }

 .no-session-container {
 display: flex;
 justify-content: center;
 align-items: center;
 height: 100vh;
 background-color: var(--white);
 position: fixed;
 top: 0;
 left: 0;
 width: 100%;
 z-index: 9999;
 }

 .no-session-content {
 background: #fff;
 padding: 40px;
 border-radius: 0;
 box-shadow: none;
 width: 100%;
 max-width: 100%;
 height: 100vh;
 text-align: center;
 display: flex;
 flex-direction: column;
 justify-content: center;
 align-items: center;
 }

 .no-session-content h2 { margin-bottom: 20px; color: var(--dark-color); }
 .no-session-content p { margin-bottom: 30px; color: var(--grey-color); line-height: 1.6; }

 .no-session-content button {
 width: 100%;
 max-width: 450px;
 padding: 14px;
 border: none;
 border-radius: var(--button-border-radius);
 font-size: 16px;
 cursor: pointer;
 font-family: 'Vazirmatn', Arial, sans-serif;
 margin-bottom: 10px;
 transition: var(--transition);
 }

 .login-button { background: var(--gradient); color: white; }
 .login-button:hover { box-shadow: var(--shadow); transform: translateY(-2px); }

 * {
 margin: 0;
 padding: 0; 
 box-sizing: border-box;
 }

 body {
 font-family: 'Vazirmatn', Arial, sans-serif;
 background-color: var(--light-color); 
 direction: rtl;
 text-align: right;
 color: var(--dark-color); 
 line-height: 1.6;
 position: relative;
 overflow-x: hidden;
 -webkit-user-select: none;
 -moz-user-select: none;
 -ms-user-select: none;
 user-select: none;
 }

 .header { 
 background-color: #ffffff;
 padding: 15px 0px 15px 20px;
 box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
 display: flex;
 justify-content: space-between;
 align-items: center;
 position: sticky;
 top: 0;
 z-index: 1000; 
 }
 
 .hamburger-menu {
    flex: 0 0 auto;
    display: flex;
    justify-content: flex-start;
 }

 .menu-tab-button { 
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 12px 50px 12px 25px;
    font-family: 'Vazirmatn', Arial, sans-serif;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    border-radius: 15px 0 0 15px;
    transition: var(--transition);
    box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.1);
 }

 .menu-tab-button:hover {
 background-color: var(--secondary-color);
 transform: translateX(5px); 
 }
 
 .logo-container { flex-grow: 1; display: flex; justify-content: center; } 
 .logo-placeholder { 
 width: 240px; 
 height: 80px; 
 background-image: url('images/logo.png'); 
 background-size: contain;
 background-repeat: no-repeat;
 background-position: center;
 }
 
 .header-icons-wrapper {
    flex: 0 0 120px;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    gap: 10px;
    padding-left: 20px;
 }

.header-icon-button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: var(--transition);
    text-decoration: none;
    position: relative; /* Needed for badge positioning */
}

.header-icon-button:hover { background-color: var(--primary-light); }
#adsIcon, #messagesIcon { color: var(--primary-color); }

/* START: New Styles for Unread Badge */
.unread-badge {
    position: absolute;
    top: 4px;
    left: 4px; /* On RTL, this is top-right corner */
    background-color: var(--danger-color);
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    font-weight: 700;
    display: flex;
    justify-content: center;
    align-items: center;
    line-height: 1;
    border: 2px solid var(--white);
    display: none; /* Hidden by default */
}

.unread-badge.show {
    display: flex; /* Show when it has content */
}
/* END: New Styles for Unread Badge */

 .overlay {
 position: fixed;
 top: 0; left: 0; right: 0; bottom: 0;
 background-color: rgba(0, 0, 0, 0.5);
 z-index: 999;
 opacity: 0;
 visibility: hidden;
 transition: var(--transition);
 }

 .overlay.active { opacity: 1; visibility: visible; }

 .sidebar {
 position: fixed;
 top: 0;
 right: -100%;
 width: 75%;
 max-width: 360px;
 height: 100%;
 background-color: var(--white);
 box-shadow: -3px 0 15px rgba(0, 0, 0, 0.1);
 z-index: 1000;
 transition: right 0.3s ease-out;
 overflow-y: auto;
 padding: 20px;
 display: flex;
 flex-direction: column;
 }

 .sidebar.active { right: 0; }

 .sidebar-header {
 display: flex;
 align-items: center;
 padding-bottom: 20px;
 margin-bottom: 20px;
 border-bottom: 1px solid var(--border-color); 
 position: relative;
 justify-content: flex-start;
 min-height: 60px;
 }

 .sidebar-logo {
 position: absolute;
 left: 50%;
 transform: translateX(-50%);
 display: flex;
 align-items: center;
 justify-content: center;
 height: auto; 
 width: auto; 
 max-width: calc(100% - 80px);
 }

 .sidebar-logo-image { height: 60px; width: auto; }

 .sidebar-close {
 flex-shrink: 0;
 margin-left: auto;
 position: relative;
 z-index: 10;
 background: none;
 border: none;
 font-size: 24px;
 color: var(--grey-color);
 cursor: pointer;
 padding: 5px;
 }

 .user-profile {
 padding: 10px 20px;
 margin-bottom: 15px;
 background: var(--gradient);
 border-radius: var(--border-radius);
 color: var(--white);
 text-align: center;
 }

 .user-avatar { display: none; }
 .user-info h3 { margin-top: 0; margin-bottom: 0; font-size: 15px; font-weight: 600; }
 .user-info p { display: none; }

 .sidebar-menu { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
 .sidebar-menu-item {
 display: flex;
 align-items: center;
 padding: 14px 16px;
 border-radius: var(--border-radius);
 text-decoration: none;
 color: var(--dark-color); 
 transition: var(--transition);
 cursor: pointer;
 }
 .sidebar-menu-item:hover { background-color: var(--primary-light); transform: translateX(-5px); }
 .sidebar-menu-item.logout { background-color: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
 .sidebar-menu-item.logout:hover { background-color: #ffcdd2; }
 .sidebar-menu-icon {
 width: 40px;
 height: 40px;
 background-color: var(--primary-light); 
 border-radius: 50%;
 display: flex;
 justify-content: center;
 align-items: center;
 margin-left: 15px;
 }
 .sidebar-menu-icon i { color: var(--primary-color); font-size: 18px; }
 .sidebar-menu-item.logout .sidebar-menu-icon i { color: #c62828; }
 .sidebar-menu-text { font-size: 15px; font-weight: 500; }

 .sidebar-footer { margin-top: auto; padding-top: 20px; border-top: 1px solid var(--border-color); text-align: center; }
 .sidebar-version { font-size: 12px; color: var(--grey-color); }

 .main-content { padding: 20px; }
 
 .main-banner {
    width: 100%;
    height: 3cm; 
    background-image: url('images/sarbarg1.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    border-radius: var(--border-radius);
    box-shadow: var(--subtle-shadow);
    overflow: hidden;
    margin-bottom: 20px;
 }

 .persuasive-text-container {
    width: 100%;
    padding: 15px 25px;
    text-align: center;
    background-color: var(--white);
    border-radius: var(--border-radius);
    box-shadow: var(--subtle-shadow);
    margin-bottom: 20px;
 }
 .persuasive-text-container h2 {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 10px;
    color: var(--dark-color);
 }
 .persuasive-text-container p {
    font-size: 1rem;
    color: var(--grey-color);
    line-height: 1.8;
    max-width: 800px;
    margin: 0 auto;
    text-align: justify;
 }

 .separator-bar {
 width: 100%;
 height: 0.5cm;
 background: var(--gradient);
 margin-bottom: 20px;
 border-radius: var(--border-radius);
 box-shadow: var(--subtle-shadow);
 }

.features-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

.feature-card {
    background-color: var(--white);
    border-radius: var(--border-radius);
    padding: 20px;
    text-align: center;
    text-decoration: none;
    color: var(--dark-color);
    box-shadow: var(--subtle-shadow);
    transition: var(--transition);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 160px;
}

.feature-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--card-shadow);
}

.feature-icon {
    width: 70px;
    height: 70px;
    background-color: var(--primary-light);
    border-radius: 50%;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
}

.feature-icon i {
    color: var(--primary-color);
    font-size: 30px;
}

.feature-title {
    font-size: 1.1rem;
    font-weight: 600;
}
 
 @media (max-width: 768px) {
 .logo-placeholder { width: 150px; height: 60px; }
 .separator-bar { height: 0.3cm; }
 .menu-tab-button { font-size: 14px; padding: 10px 35px 10px 20px; }
 .sidebar { width: 90%; }
 .header-icons-wrapper { flex-basis: 90px; padding-left: 10px; }
 .persuasive-text-container { padding: 10px 15px; }
 .persuasive-text-container h2 { font-size: 1.1rem; }
 .persuasive-text-container p { font-size: 0.9rem; }
 
 .features-grid {
    gap: 10px;
 }
 .feature-card {
    padding: 15px;
    min-height: 130px;
 }
 .feature-icon {
    width: 55px;
    height: 55px;
 }
 .feature-icon i {
    font-size: 24px;
 }
 .feature-title {
    font-size: 0.9rem;
 }
 }

 .header, #app-container { display: none; }

 #payment-container {
 display: flex; justify-content: center; align-items: center; height: 100vh;
 background-color: var(--light-color); position: fixed; top: 0; left: 0; width: 100%; z-index: 9998; 
 }
 #payment-container > div { background: #fff; padding: 40px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); width: 100%; max-width: 450px; text-align: center; }
 #payment-container h2 { margin-bottom: 10px; color: var(--dark-color); }
 #payment-container p { margin-top: 10px; margin-bottom: 25px; color: var(--grey-color); font-size: 15px; }
 #payment-container button { width: 100%; padding: 14px; border: none; border-radius: var(--button-border-radius); font-size: 16px; cursor: pointer; font-family: 'Vazirmatn', Arial, sans-serif; margin-bottom: 10px; transition: var(--transition); }
 #payment-container #pay-now-button { background: var(--gradient); color: white; }
 #payment-container #pay-now-button:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
 #payment-container #logout-button-payment { background: none; color: var(--grey-color); border: 1px solid var(--border-color); }
 #payment-container #logout-button-payment:hover { background-color: var(--primary-light); }
 #payment-container #payment-message { margin-top: 20px; color: red; font-size: 14px; }
 body.loading::after { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.7) url('data:image/svg+xml;charset=UTF-8,%3csvg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"%3e%3cstyle%3e.spinner_V8m1%7btransform-origin:center;animation:spinner_zKoa 2s linear infinite%7d.spinner_V8m1 circle%7bstroke-linecap:round;animation:spinner_YpZS 1.5s ease-in-out infinite%7d@keyframes spinner_zKoa%7b100%25%7btransform:rotate(360deg)%7d%7d@keyframes spinner_YpZS%7b0%25%7bstroke-dasharray:0 150;stroke-dashoffset:0%7d47.5%25%7bstroke-dasharray:42 150;stroke-dashoffset:-16%7d95%25,100%25%7bstroke-dasharray:42 150;stroke-dashoffset:-59%7d%7d%3c/style%3e%3cg class="spinner_V8m1"%3e%3ccircle cx="20" cy="20" r="9.5" fill="none" stroke="%2300D968" stroke-width="3"%3e%3c/circle%3e%3c/g%3e%3c/svg%3e') center / 50px no-repeat; z-index: 10000; }
 body.loading { pointer-events: none; }

 .modal {
 display: none; position: fixed; z-index: 10002; left: 0; top: 0; width: 100%; height: 100%;
 overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; font-family: 'Vazirmatn', Arial, sans-serif;
 }
 .modal.active { display: flex; }
 .modal-content {
 background-color: var(--white); margin: auto; padding: 30px; border-radius: var(--border-radius); box-shadow: var(--card-shadow);
 width: 90%; max-width: 450px; text-align: center; position: relative; animation: fadeIn 0.3s ease-out;
 }
 @keyframes fadeIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
 .modal-content h2 { margin-bottom: 15px; color: var(--dark-color); font-size: 24px; }
 .modal-content p { color: var(--grey-color); font-size: 16px; margin-bottom: 30px; }
 .modal-actions { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
 .modal-actions button {
 width: 100%; padding: 14px; border: none; border-radius: var(--button-border-radius); font-size: 16px;
 cursor: pointer; font-family: 'Vazirmatn', Arial, sans-serif; transition: var(--transition); font-weight: 500;
 }
 .modal-actions .confirm-button { background: var(--gradient); color: white; }
 .modal-actions .confirm-button:hover { box-shadow: var(--shadow); transform: translateY(-2px); }
 .modal-actions .cancel-button { background: none; color: var(--grey-color); border: 1px solid var(--border-color); }
 .modal-actions .cancel-button:hover { background-color: var(--primary-light); }

.update-notification-banner {
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 300px;
    background-color: var(--primary-color);
    color: white;
    padding: 15px 20px;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    z-index: 10000;
    transform: translateY(150%);
    transition: transform 0.5s ease-out;
}
.update-notification-banner.show { transform: translateY(0); }
.update-notification-banner p { margin: 0; font-size: 15px; font-weight: 500; }
.update-notification-banner button {
    background-color: var(--white);
    color: var(--primary-color);
    border: none;
    padding: 8px 15px;
    border-radius: 8px;
    font-family: 'Vazirmatn', Arial, sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
}
.update-notification-banner button:hover { background-color: var(--primary-light); color: var(--secondary-color); }
@media (max-width: 600px) { .update-notification-banner { width: calc(100% - 40px); left: 20px; right: 20px; bottom: 15px; } }
 </style>
</head>
<body>

<!-- صفحه عدم ورود -->
<div id="no-session-container" class="no-session-container" style="display: none;">
 <div class="no-session-content">
 <i class="fas fa-sign-in-alt" style="font-size: 60px; color: var(--primary-color); margin-bottom: 20px;"></i>
 <h2>ورود به حساب کاربری</h2>
 <p>برای استفاده از رادار اینستاگرام، لطفاً ابتدا وارد حساب کاربری خود شوید یا حساب جدید ایجاد کنید.</p>
 <button class="login-button" onclick="goToRegister()">
 <i class="fas fa-user-plus"></i> ورود / ثبت‌نام
 </button>
 </div>
</div>

<div id="payment-notification" class="payment-notification">
 <i id="notification-icon" class="notification-icon fas"></i>
 <div class="notification-content"><strong id="notification-title"></strong><p id="notification-message"></p></div>
 <button id="notification-close" class="notification-close">&times;</button>
</div>

<div id="multiDeviceModal" class="modal">
 <div class="modal-content">
 <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: var(--danger-color); margin-bottom: 20px;"></i>
 <h2>ورود از دستگاه دیگر</h2>
 <p id="multiDeviceMessage">شما با ایمیل <strong id="conflictingEmailDisplay"></strong> در دستگاه دیگری وارد شده‌اید. آیا می‌خواهید از آن دستگاه خارج و در این دستگاه وارد شوید؟</p>
 <div class="modal-actions">
 <button id="confirmSwitchDevice" class="confirm-button">بله، وارد شوم</button>
 <button id="cancelSwitchDevice" class="cancel-button">خیر، لغو</button>
 </div>
 </div>
</div>

<div id="payment-container" style="display: none;">
 <div>
 <i class="fas fa-exclamation-circle" style="font-size: 60px; color: var(--primary-color); margin-bottom: 20px;"></i>
 <h2>حساب شما فعال نیست</h2>
 <p>دوره آزمایشی شما به پایان رسیده است. برای دسترسی کامل، اشتراک خود را فعال کنید.</p>
 <button id="pay-now-button"><i class="fas fa-credit-card"></i> فعال‌سازی و پرداخت</button>
 <button id="logout-button-payment"><i class="fas fa-sign-out-alt"></i> خروج از حساب</button>
 <p id="payment-message"></p>
 </div>
</div>

<header class="header">
 <div class="hamburger-menu">
 <button class="menu-tab-button" id="hamburgerIcon">منو</button>
 </div>
 <div class="logo-container">
 <div class="logo-placeholder"></div> 
 </div>
 <div class="header-icons-wrapper">
  <a href="tablighat.html" class="header-icon-button" id="adsIcon" title="تبلیغات"><i class="fas fa-bullhorn"></i></a>
  <a href="message.html" class="header-icon-button" id="messagesIcon" title="پیام‌ها">
    <i class="fas fa-envelope"></i>
    <span id="unread-badge" class="unread-badge"></span>
  </a>
 </div>
</header>

<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
 <div class="sidebar-header">
 <div class="sidebar-logo"><img src="images/logo.png" alt="لوگو" class="sidebar-logo-image"></div>
 <button class="sidebar-close" id="sidebarClose"><i class="fas fa-times"></i></button>
 </div>
 <div class="user-profile" id="userProfile">
 <div class="user-avatar"><i class="fas fa-user"></i></div>
 <div class="user-info"><h3 id="userName"></h3><p id="userEmail"></p></div>
 </div>
 <div class="sidebar-menu">
 <a href="about-app.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-info-circle"></i></div><div class="sidebar-menu-text">درباره برنامه</div></a>
 <a href="amoozesh.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-video"></i></div><div class="sidebar-menu-text">آموزش ویدئویی</div></a>
 <a href="message.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-envelope"></i></div><div class="sidebar-menu-text">پیام‌ها</div></a>
 <a href="karbari.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-user-circle"></i></div><div class="sidebar-menu-text">حساب کاربری</div></a>
 <a href="contact.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-headset"></i></div><div class="sidebar-menu-text">راه‌های ارتباطی</div></a>
 <a href="settings.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-cog"></i></div><div class="sidebar-menu-text">تنظیمات</div></a>
 <a href="admin.html" class="sidebar-menu-item"><div class="sidebar-menu-icon"><i class="fas fa-user-shield"></i></div><div class="sidebar-menu-text">ادمین</div></a>
 <div class="sidebar-menu-item logout" id="logoutButtonSidebar"><div class="sidebar-menu-icon"><i class="fas fa-sign-out-alt"></i></div><div class="sidebar-menu-text">خروج از حساب</div></div>
 </div>
 <div class="sidebar-footer"><div class="sidebar-version">نسخه 1.0.0</div></div>
</div>

<div id="app-container">
    <main class="main-content" id="mainContent">
        <div class="main-banner"></div>
        <div class="persuasive-text-container">
            <h2>مدیریت پیجتو تو دستت بگیر</h2>
            <p>تمام فالوورها، فالویینگ‌ها، محتوا و هر آنچه برای رشد پیجت لازمه رو با ابزارهای هوشمند رادار، یکجا و حرفه‌ای مدیریت کن.</p>
        </div>
        <div class="separator-bar"></div>

        <div class="features-grid" id="features-grid">
            <a href="follower-management.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-users"></i></div>
                <h3 class="feature-title">مدیریت فالوورها</h3>
            </a>
            <a href="following.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-user-check"></i></div>
                <h3 class="feature-title">مدیعه فالویینگ‌ها</h3>
            </a>
            <a href="direct-marketing.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-paper-plane"></i></div>
                <h3 class="feature-title">دایرکت مارکتینگ</h3>
            </a>
            <a href="content-calendar.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-calendar-alt"></i></div>
                <h3 class="feature-title">تقویم محتوا</h3>
            </a>
            <a href="daily-engagement.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-heart"></i></div>
                <h3 class="feature-title">تعامل روزانه</h3>
            </a>
            <a href="checklist-content.html" class="feature-card">
                <div class="feature-icon"><i class="fas fa-tasks"></i></div>
                <h3 class="feature-title">چک‌لیست محتوا</h3>
            </a>
        </div>
        
        <div class="main-banner" style="background-image: url('images/sarbarg2.png');"></div>

        <div id="payment-iframe-container" style="display:none;"></div>

    </main>
</div>

<div id="update-notification-banner" class="update-notification-banner">
    <p>نسخه جدید برنامه در دسترس است!</p>
    <button id="reload-app-button">به‌روزرسانی و بارگذاری مجدد</button>
</div>

<script>
let currentUserEmail = null; 
let currentDeviceId = null; 
let conflictingLoginEmail = null;

function goToRegister() { window.location.href = 'register.html'; }
function generateDeviceId() { let deviceId = localStorage.getItem('deviceId'); if (!deviceId) { deviceId = 'device-' + Math.random().toString(36).substr(2, 9) + '-' + Date.now(); localStorage.setItem('deviceId', deviceId); } return deviceId; }

async function makeWorkerRequest(endpoint, data = null, method = 'GET') { 
    const url = `https://weathered-sun-e806.toolbox-moein.workers.dev${endpoint}`; 
    const options = { method: method, headers: { 'Content-Type': 'application/json' } }; 
    const sessionToken = localStorage.getItem('sessionToken'); 
    if (sessionToken) { options.headers['Authorization'] = `Bearer ${sessionToken}`; } 
    if (data && method !== 'GET') { options.body = JSON.stringify(data); } 
    try { 
        const response = await fetch(url, options); 
        const result = await response.json(); 
        return { success: response.ok, status: response.status, data: result }; 
    } catch (error) { 
        console.error('Request failed:', error); 
        return { success: false, error: 'خطای شبکه رخ داد' }; 
    } 
}

async function checkSession() { 
    const sessionToken = localStorage.getItem('sessionToken'); 
    if (!sessionToken) { return null; } 
    const result = await makeWorkerRequest('/getsession', null, 'POST'); 
    if (result.success && result.data && result.data.user) { return result.data; } 
    else { localStorage.removeItem('sessionToken'); return null; } 
}

async function performLogout() { 
    try { await makeWorkerRequest('/signout', null, 'POST'); } 
    catch (error) { console.error("Logout error:", error); } 
    localStorage.removeItem('sessionToken'); 
    localStorage.removeItem('deviceId'); 
    showNoSessionPage(); 
}

function showNoSessionPage() { 
    const elementsToHide = ['.header', '#app-container', '#payment-container']; 
    elementsToHide.forEach(selector => { const el = document.querySelector(selector); if(el) el.style.display = 'none'; }); 
    const noSessionContainer = document.getElementById('no-session-container'); 
    if(noSessionContainer) noSessionContainer.style.display = 'flex'; 
}

async function loadUserProfile() { 
    const session = await checkSession(); 
    if (!session || !session.user) { 
        document.getElementById('userName').textContent = 'مهمان'; 
        return; 
    } 
    const { firstName = '', lastName = '' } = session.user; 
    const fullName = `${firstName} ${lastName}`.trim(); 
    document.getElementById('userName').textContent = fullName || session.user.email; 
}

function handlePaymentResult() { 
    const urlParams = new URLSearchParams(window.location.search); 
    const paymentStatus = urlParams.get('payment'); 
    if (!paymentStatus) return; 
    const notification = document.getElementById('payment-notification'); 
    const icon = document.getElementById('notification-icon'); 
    const title = document.getElementById('notification-title'); 
    const message = document.getElementById('notification-message'); 
    const closeBtn = document.getElementById('notification-close'); 
    let notificationTimeout; 
    function showNotification(type, titleText, messageText) { 
        clearTimeout(notificationTimeout); 
        notification.className = `payment-notification ${type} show`; 
        icon.className = `notification-icon fas ${type === 'success' ? 'fa-check-circle' : 'fa-times-circle'}`; 
        title.textContent = titleText; 
        message.textContent = messageText; 
        notificationTimeout = setTimeout(() => notification.classList.remove('show'), 5000); 
    } 
    closeBtn.onclick = () => { clearTimeout(notificationTimeout); notification.classList.remove('show'); }; 
    if (paymentStatus === 'success') { showNotification('success', 'پرداخت موفق', 'اشتراک شما با موفقیت فعال گردید.'); } 
    else if (paymentStatus === 'failed') { showNotification('failed', 'پرداخت ناموفق', 'پرداخت لغو شد یا با خطا مواجه گردید.'); } 
    history.replaceState(null, '', window.location.pathname); 
}

function loadPaymentPage() {
    const container = document.getElementById('payment-iframe-container');
    const featuresGrid = document.getElementById('features-grid');
    if (featuresGrid) featuresGrid.style.display = 'none';
    if (container) {
        container.style.display = 'block';
        const iframe = document.createElement('iframe'); 
        iframe.style.cssText = 'width: 100%; height: 80vh; border: none; border-radius: var(--border-radius);'; 
        iframe.src = 'payment.html'; 
        container.innerHTML = ''; 
        container.appendChild(iframe);
    }
}

// START: New function to check unread messages
async function checkUnreadMessages() {
    const badge = document.getElementById('unread-badge');
    if (!badge) return;

    try {
        const readMessages = JSON.parse(localStorage.getItem('readMessages')) || [];
        
        // Define static messages to include them in the count
        const WELCOME_MESSAGE = { id: 'static-welcome-message' };
        const AD_MESSAGE = { id: 'static-ad-message' };

        // Fetch dynamic messages from the server
        const response = await makeWorkerRequest('/messages');
        let dynamicMessages = [];
        if (response.success && Array.isArray(response.data.messages)) {
            dynamicMessages = response.data.messages;
        }

        const allMessages = [WELCOME_MESSAGE, AD_MESSAGE, ...dynamicMessages];
        
        const unreadCount = allMessages.filter(msg => msg.id && !readMessages.includes(msg.id)).length;

        if (unreadCount > 0) {
            badge.textContent = unreadCount;
            badge.classList.add('show');
        } else {
            badge.classList.remove('show');
        }
    } catch (error) {
        console.error("Error checking unread messages:", error);
        badge.classList.remove('show');
    }
}
// END: New function

async function checkAuthStateAndDisplayContent() { 
    handlePaymentResult(); 
    currentDeviceId = generateDeviceId(); 
    const urlParams = new URLSearchParams(window.location.search); 
    if (urlParams.get('loginConflict') === 'true' && urlParams.get('email')) { 
        document.getElementById('conflictingEmailDisplay').textContent = decodeURIComponent(urlParams.get('email')); 
        document.getElementById('multiDeviceModal').classList.add('active'); 
        document.body.style.overflow = 'hidden'; 
        history.replaceState(null, '', window.location.pathname); 
        return; 
    } 
    const session = await checkSession(); 
    if (!session || !session.user) { 
        showNoSessionPage(); 
        return; 
    } 
    currentUserEmail = session.user.email; 
    const { subscriptionStatus, createdAt: userCreatedAt } = session.user; 
    if (!userCreatedAt || !subscriptionStatus) { 
        alert("خطا در دریافت اطلاعات کاربری."); 
        showNoSessionPage(); 
        return; 
    } 
    const elementsToShow = ['.header', '#app-container']; 
    elementsToShow.forEach(selector => { const el = document.querySelector(selector); const displayType = selector === '.header' ? 'flex' : 'block'; if(el) el.style.display = displayType; }); 
    const isSubscriptionActive = subscriptionStatus === 'active'; 
    const trialEndDate = new Date(new Date(userCreatedAt).getTime() + 7 * 24 * 60 * 60 * 1000); 
    const isTrialPeriod = new Date() <= trialEndDate; 
    
    if (isSubscriptionActive || isTrialPeriod || session.user.email === "toolbox.moein@gmail.com") { 
        document.getElementById('features-grid').style.display = 'grid';
        document.getElementById('payment-iframe-container').style.display = 'none';
    } else { 
        loadPaymentPage();
    } 
    await loadUserProfile();
    await checkUnreadMessages(); // Call the new function here
}

function openMenu() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); if (sidebar && overlay) { sidebar.classList.add('active'); overlay.classList.add('active'); document.body.style.overflow = 'hidden'; } }
function closeMenu() { const sidebar = document.getElementById('sidebar'); const overlay = document.getElementById('overlay'); if (sidebar && overlay) { sidebar.classList.remove('active'); overlay.classList.remove('active'); document.body.style.overflow = ''; } }

document.addEventListener('DOMContentLoaded', function() { 
    checkAuthStateAndDisplayContent(); 
    window.addEventListener('message', (event) => { 
        if (event.data && event.data.type === 'logoutRequest') { 
            performLogout(); 
        } 
    }); 
    document.getElementById('hamburgerIcon')?.addEventListener('click', (e) => { e.preventDefault(); openMenu(); }); 
    document.getElementById('sidebarClose')?.addEventListener('click', closeMenu); 
    document.getElementById('overlay')?.addEventListener('click', closeMenu); 
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeMenu(); } }); 
    document.querySelectorAll('#logoutButtonSidebar, #logout-button-payment').forEach(btn => { 
        btn?.addEventListener('click', (e) => { e.preventDefault(); performLogout(); }); 
    }); 
    document.getElementById('confirmSwitchDevice')?.addEventListener('click', () => alert('این قابلیت در حال توسعه است')); 
    document.getElementById('cancelSwitchDevice')?.addEventListener('click', () => { 
        document.getElementById('multiDeviceModal').classList.remove('active'); 
        document.body.style.overflow = ''; 
        goToRegister(); 
    }); 
    
    // START: Service Worker Update Logic (این بخش از کد شما کاملاً صحیح است و تغییر نکرد)
    if ('serviceWorker' in navigator) {
        let newWorker; 
        const updateBanner = document.getElementById('update-notification-banner');
        const reloadButton = document.getElementById('reload-app-button');

        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('Service Worker registered with scope:', registration.scope);
                registration.onupdatefound = () => {
                    newWorker = registration.installing; 
                    if (newWorker) {
                        newWorker.onstatechange = () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    console.log('Service Worker: New update available!');
                                    updateBanner.classList.add('show'); 
                                } else {
                                    console.log('Service Worker: Initial install complete.');
                                }
                            }
                        };
                    }
                };
            })
            .catch(error => {
                console.error('Service Worker registration failed:', error);
            });

        if (reloadButton) {
            reloadButton.addEventListener('click', () => {
                if (newWorker && newWorker.state === 'installed') {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                }
                window.location.reload(); 
            });
        }

        navigator.serviceWorker.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'UPDATE_READY') {
                console.log('Service Worker: Message received - update ready!');
                updateBanner.classList.add('show');
            }
        });
    }
    // END: Service Worker Update Logic
});
</script>

</body>
</html>